<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="小彭老师">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>现代 C++ 的 CUDA 编程 - ✝️小彭大典✝️</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../css/print-site.css" rel="stylesheet">
        <link href="../css/print-site-mkdocs.css" rel="stylesheet">
        <link href="../extra.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cpp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/diff.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/java.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/llvm.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/nasm.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/txt.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">✝️小彭大典✝️</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">章节列表</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href=".." class="dropdown-item">前言</a>
</li>
                                    
<li>
    <a href="../hello_world/" class="dropdown-item">你好，世界</a>
</li>
                                    
<li>
    <a href="../platform/" class="dropdown-item">开发环境与平台选择</a>
</li>
                                    
<li>
    <a href="../variable_types/" class="dropdown-item">变量与类型 (未完工)</a>
</li>
                                    
<li>
    <a href="../functions/" class="dropdown-item">认识函数 (未完工)</a>
</li>
                                    
<li>
    <a href="../auto/" class="dropdown-item">auto 神教</a>
</li>
                                    
<li>
    <a href="../symbols/" class="dropdown-item">重新认识声明与定义（未完工）</a>
</li>
                                    
<li>
    <a href="../cpp_tricks/" class="dropdown-item">应知应会 C++ 小技巧</a>
</li>
                                    
<li>
    <a href="../lambda/" class="dropdown-item">小彭老师带你学函数式编程</a>
</li>
                                    
<li>
    <a href="../type_rich_api/" class="dropdown-item">现代化的 API 设计指南</a>
</li>
                                    
<li>
    <a href="../no_more_new/" class="dropdown-item">现代 C++ 从拒绝 new 开始</a>
</li>
                                    
<li>
    <a href="../stl_map/" class="dropdown-item">STL 精讲：std::map 和他的朋友们</a>
</li>
                                    
<li>
    <a href="../design_overview/" class="dropdown-item">设计模式总览 (未完工)</a>
</li>
                                    
<li>
    <a href="../design_virtual/" class="dropdown-item">让虚函数再次伟大！</a>
</li>
                                    
<li>
    <a href="../design_gamedev/" class="dropdown-item">游戏开发中常用的设计模式</a>
</li>
                                    
<li>
    <a href="../design_functor/" class="dropdown-item">函数式设计模式</a>
</li>
                                    
<li>
    <a href="../design_variant/" class="dropdown-item">静态多态与面向数据编程 (未完工)</a>
</li>
                                    
<li>
    <a href="../design_erasure/" class="dropdown-item">类型擦除神教及其实现 (未完工)</a>
</li>
                                    
<li>
    <a href="../design_concept/" class="dropdown-item">鸭子类型与 C++20 concept (未完工)</a>
</li>
                                    
<li>
    <a href="../error_code/" class="dropdown-item">现代 C++ 错误处理知多少（未完工）</a>
</li>
                                    
<li>
    <a href="../cpp_lifetime/" class="dropdown-item">深入理解析构函数与生命周期</a>
</li>
                                    
<li>
    <a href="../cpp_memory/" class="dropdown-item">真正的 C++ 内存模型！ (未完工)</a>
</li>
                                    
<li>
    <a href="../unicode/" class="dropdown-item">字符编码那些事</a>
</li>
                                    
<li>
    <a href="../threading/" class="dropdown-item">C++ 多线程编程（未完工）</a>
</li>
                                    
<li>
    <a href="../test_and_safe/" class="dropdown-item">测试与安全话题（未完工）</a>
</li>
                                    
<li>
    <a href="../undef/" class="dropdown-item">未定义行为完整列表</a>
</li>
                                    
<li>
    <a href="../llvm_intro/" class="dropdown-item">小彭老师带你学 LLVM</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">现代 C++ 的 CUDA 编程</a>
</li>
                                    
<li>
    <a href="../cmake_tutor/" class="dropdown-item">学现代 C++ 从现代 CMake 学起（未完工）</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">关于</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../about/" class="dropdown-item">关于小彭老师</a>
</li>
                                    
<li>
    <a href="../donate/" class="dropdown-item">赞助名单</a>
</li>
                                    
<li>
    <a href="../interview/" class="dropdown-item">小彭老师面试经验</a>
</li>
                                    
<li>
    <a href="../recommend/" class="dropdown-item">参考资料与项目</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/parallel101/cppguidebook" class="nav-link">GitHub</a>
                            </li>
                            <li class="nav-item">
                                <a href="https://space.bilibili.com/263032155" class="nav-link">Bilibili</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../llvm_intro/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../cmake_tutor/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/parallel101/cppguidebook/edit/master/docs/cuda_intro.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#c-cuda" class="nav-link">现代 C++ 的 CUDA 编程</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#cuda" class="nav-link">配置 CUDA 开发环境</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#cuda_4" class="nav-link">开始编写 CUDA</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="c-cuda">现代 C++ 的 CUDA 编程</h1>
<div class="toc">
<ul>
<li><a href="#c-cuda">现代 C++ 的 CUDA 编程</a><ul>
<li><a href="#cuda">配置 CUDA 开发环境</a><ul>
<li><a href="#nvidia">安装 NVIDIA 驱动</a></li>
<li><a href="#cuda_1">安装 CUDA</a></li>
<li><a href="#_1">常见问题解答</a></li>
<li><a href="#cmake">建议开启的 CMake 选项</a><ul>
<li><a href="#cuda_2">CUDA 编译器路径</a></li>
<li><a href="#cuda-c">CUDA C++ 版本</a></li>
</ul>
</li>
<li><a href="#c">赋能现代 C++ 语法糖</a><ul>
<li><a href="#_2">显卡架构版本号</a></li>
<li><a href="#_3">设备函数分离定义</a></li>
<li><a href="#cuda_3">创建 CUDA 项目</a></li>
<li><a href="#cmake_1">CMake 配置总结</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cuda_4">开始编写 CUDA</a></li>
</ul>
</li>
</ul>
</div>
<p>参考资料：</p>
<ul>
<li>https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html</li>
<li>https://www.cs.sfu.ca/~ashriram/Courses/CS431/assets/lectures/Part8/GPU1.pdf</li>
</ul>
<h2 id="cuda">配置 CUDA 开发环境</h2>
<p>硬件方面建议使用至少 GTX 1060 以上显卡，但是更老的显卡也可以运行。</p>
<p>软件方面则可以尽可能最新，以获得 CUDA C++20 支持，我安装的版本是 CUDA 12.5。</p>
<p>以下仅演示 Arch Linux 中安装 CUDA 的方法，因为 Arch Linux 官方源中就自带 <code>nvidia</code> 驱动和 <code>cuda</code> 包，而且开箱即用，其他发行版请自行如法炮制。</p>
<p>Wendous 用户可能在安装完后遇到“找不到 cuxxx.dll”报错，说明你需要拷贝 CUDA 安装目录下的所有 DLL 到 <code>C:\\Windows\\System32</code>。</p>
<p>WSL 用户要注意，WSL 环境和真正的 Linux 相差甚远。很多 Linux 下的教程，你会发现在 WSL 里复刻不出来。这是 WSL 的 bug，应该汇报去让微软统一修复，而不是让教程的作者零零散散一个个代它擦屁股。建议直接在 Wendous 本地安装 CUDA 反而比伺候 WSL 随机拉的 bug 省力。</p>
<p>Ubuntu 用户可能考虑卸载 Ubuntu，因为 Ubuntu 源中的版本永不更新。想要安装新出的软件都非常困难，基本只能安装到五六年前的古董软件，要么只能从网上下 deb 包，和 Wendous 一个软耸样。所有官方 apt 源中包的版本从 Ubuntu 发布那一天就定死了，永远不会更新了。这是为了起夜级服务器安全稳定的需要，对于个人电脑而言却只是白白阻碍我们学习，Arch Linux 这样的滚动更新的发行版才更适合个人桌面用户。</p>
<h3 id="nvidia">安装 NVIDIA 驱动</h3>
<p>首先确保你安装了 NVIDIA 最新驱动：</p>
<pre><code class="language-bash">pacman -S nvidia
</code></pre>
<p>运行以下命令，确认显卡驱动正常工作：</p>
<pre><code class="language-bash">nvidia-smi
</code></pre>
<p>应该能得到：</p>
<pre><code>Mon Aug 26 14:09:15 2024
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 555.58.02              Driver Version: 555.58.02      CUDA Version: 12.5     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA GeForce RTX 4070 ...    Off |   00000000:01:00.0  On |                  N/A |
|  0%   30C    P8             17W /  285W |     576MiB /  16376MiB |     41%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+

+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|    0   N/A  N/A       583      G   /usr/lib/Xorg                                 370MiB |
|    0   N/A  N/A       740      G   xfwm4                                           4MiB |
|    0   N/A  N/A       783      G   /usr/lib/firefox/firefox                      133MiB |
|    0   N/A  N/A      4435      G   obs                                            37MiB |
+-----------------------------------------------------------------------------------------+
</code></pre>
<p>如果不行，那就重启。</p>
<h3 id="cuda_1">安装 CUDA</h3>
<p>然后安装 CUDA Toolkit（即 nvcc 编译器）：</p>
<pre><code class="language-bash">pacman -S cuda
</code></pre>
<p>打开 <code>.bashrc</code>（如果你是 zsh 用户就打开 <code>.zshrc</code>），在末尾添加两行：</p>
<pre><code class="language-bash">export PATH=&quot;/opt/cuda/bin:$PATH&quot;    # 这是默认的 cuda 安装位置
export NVCC_CCBIN=&quot;/usr/bin/g++-13&quot;  # Arch Linux 用户才需要这一行
</code></pre>
<p>然后重启 <code>bash</code>，或者执行以下命令重载环境变量：</p>
<pre><code class="language-bash">source .bashrc
</code></pre>
<p>运行以下命令测试 CUDA 编译器是否可用：</p>
<pre><code class="language-bash">nvcc --version
</code></pre>
<p>应该能得到：</p>
<pre><code>nvcc: NVIDIA (R) Cuda compiler driver
Copyright (c) 2005-2024 NVIDIA Corporation
Built on Thu_Jun__6_02:18:23_PDT_2024
Cuda compilation tools, release 12.5, V12.5.82
Build cuda_12.5.r12.5/compiler.34385749_0
</code></pre>
<h3 id="_1">常见问题解答</h3>
<p>CMake 报错找不到 CUDA？添加环境变量：</p>
<pre><code class="language-bash">export PATH=&quot;/opt/cuda/bin:$PATH&quot;    # 这里换成你的 cuda 安装位置
export NVCC_CCBIN=&quot;/usr/bin/g++-13&quot;  # 只有 Arch Linux 需要这一行
</code></pre>
<p>IDE 使用了 Clangd 静态检查插件，报错不认识 <code>-forward-unknown-to-host-compiler</code> 选项？</p>
<p>创建文件 <code>~/.config/clangd/config.yaml</code>：</p>
<pre><code class="language-yaml">CompileFlags:
  Add:     # 要额外添加到 Clang 的 NVCC 没有的参数
    - --no-cuda-version-check
  Remove:  # 移除 Clang 不认识的 NVCC 参数
    - -forward-unknown-to-host-compiler
    - --expt-*
    - --generate-code=*
    - -arch=*
    - -rdc=*
</code></pre>
<h3 id="cmake">建议开启的 CMake 选项</h3>
<h4 id="cuda_2">CUDA 编译器路径</h4>
<p>如果你无法搞定环境变量，也可以通过 <code>CMAKE_CUDA_COMPILER</code> 直接设置 <code>nvcc</code> 编译器的路径：</p>
<pre><code class="language-cmake">set(CMAKE_CUDA_COMPILER &quot;/opt/cuda/bin/nvcc&quot;)  # 这里换成你的 cuda 安装位置
</code></pre>
<p>不建议这样写，因为会让使用你项目的人也被迫把 CUDA 安装到这个路径去。</p>
<p>建议是把你的 <code>nvcc</code> 安装好后，通过 <code>PATH</code> 环境变量，<code>cmake</code> 就能找到了，不需要设置这个变量。</p>
<h4 id="cuda-c">CUDA C++ 版本</h4>
<p>CUDA 是一种基于 C++ 的领域特定语言，CUDA C++ 的版本和正规 C++ 一一对应。</p>
<p>目前最新的是 CUDA C++20，可以完全使用 C++20 特性的同时书写 CUDA 代码。</p>
<ul>
<li>在 <code>__host__</code> 函数（未经特殊修饰的函数默认就是此类，在 CPU 端执行）中，CUDA 和普通 C++ 没有区别，任何普通 C++ 代码，都可以用 CUDA 编译器编译。</li>
<li>在 <code>__device__</code> 函数（CUDA kernel，在 GPU 端执行）中，能使用的函数和类就有一定限制了：<ul>
<li>例如你不能在 <code>__device__</code> 函数里使用仅限 <code>__host__</code> 用的 <code>std::cout</code>（但 <code>printf</code> 可以，因为 CUDA 团队为了方便用户调试，为你做了 <code>printf</code> 的 <code>__device__</code> 版特化）。</li>
<li><code>__device__</code> 中不能使用绝大多数非 <code>constexpr</code> 的 STL 容器，例如 <code>std::map</code> 等，但是在 <code>__host__</code> 侧还是可以用的！</li>
<li>所有的 <code>constexpr</code> 函数也是可以使用的，例如各种 C++ 风格的数学函数如 <code>std::max</code>，<code>std::sin</code>，这些函数都是 <code>constexpr</code> 的，在 <code>__host__</code> 和 <code>__device__</code> 都能用。</li>
<li>如果一个容器的成员全是 <code>constexpr</code> 的，那么他可以在 <code>__device__</code> 函数中使用。例如 <code>std::tuple</code>、<code>std::array</code> 等等，因为不涉及 I/O 和内存分配，都是可以在 <code>__device__</code> 中使用的。</li>
<li>例如 C++20 增加了 constexpr-new 的支持，让 <code>std::vector</code> 和 <code>std::string</code> 变成了 <code>constexpr</code> 的容器，因此可以在 <code>__device__</code> 中使用 <code>std::vector</code>（会用到 <code>__device__</code> 版本的 <code>malloc</code> 函数，这是 CUDA 的一大特色：你可以在 kernel 内部用 <code>malloc</code> 动态分配设备内存，并且从 CUDA C++20 开始 <code>new</code> 也可以了）。</li>
<li><code>std::variant</code> 现在也是 <code>constexpr</code> 的容器，也可以在 <code>__device__</code> 函数中使用了。</li>
<li>异常目前还不是 <code>constexpr</code> 的，因此无法在 <code>__device__</code> 函数中使用 <code>try/catch/throw</code> 系列关键字。</li>
<li>总之，随着，我们可以期待越来越多纯计算的函数和容器能在 CUDA kernel（<code>__device__</code> 环境）中使用。</li>
</ul>
</li>
</ul>
<p>正如 <code>CMAKE_CXX_STANDARD</code> 设置了 <code>.cpp</code> 文件所用的 C++ 版本，也可以用 <code>CMAKE_CUDA_STANDARD</code> 设置 <code>.cu</code> 文件所用的 CUDA C++ 版本。</p>
<pre><code class="language-cmake">set(CMAKE_CXX_STANDARD 20)       # .cpp 文件采用的 C++ 版本是 C++20
set(CMAKE_CUDA_STANDARD 20)      # .cu 文件采用的 CUDA C++ 版本是 C++20
</code></pre>
<h3 id="c">赋能现代 C++ 语法糖</h3>
<pre><code class="language-cmake">set(CMAKE_CUDA_FLAGS &quot;${CMAKE_CUDA_FLAGS} --expt-relaxed-constexpr --expt-extended-lambda&quot;)
</code></pre>
<ul>
<li><code>--expt-relaxed-constexpr</code>: 让所有 <code>constexpr</code> 函数默认自动带有 <code>__host__ __device__</code></li>
<li><code>--expt-extended-lambda</code>: 允许为 lambda 表达式指定 <code>__host__</code> 或 <code>__device__</code></li>
</ul>
<h4 id="_2">显卡架构版本号</h4>
<p>不同的显卡有不同的“架构版本号”，架构版本号必须与你的硬件匹配才能最佳状态运行，可以略低，但将不能发挥完整性能。</p>
<pre><code class="language-cmake">set(CMAKE_CUDA_ARCHITECTURES 86)      # 表示针对 RTX 30xx 系列（Ampere 架构）生成
set(CMAKE_CUDA_ARCHITECTURES native)  # 如果 CMake 版本高于 3.24，该变量可以设为 &quot;native&quot;，让 CMake 自动检测当前显卡的架构版本号
</code></pre>
<p>架构版本号：例如 75 表示 RTX 20xx 系列（Turing 架构）；86 表示 RTX 30xx 系列（Ampere 架构）；89 表示 RTX 40xx 系列（Ada 架构）等。</p>
<p>完整的架构版本号列表可以在 <a href="https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/index.html#virtual-architecture-feature-list">CUDA 文档</a> 中找到。</p>
<p>也可以运行如下命令（如果有的话）查询当前显卡的架构版本号：</p>
<pre><code class="language-bash">__nvcc_device_query
</code></pre>
<h4 id="_3">设备函数分离定义</h4>
<p>默认只有 <code>__host__</code> 函数可分离声明和定义。如果你需要分离 <code>__device__</code> 函数的声明和定义，就要开启这个选项：</p>
<pre><code class="language-cmake">set(CMAKE_CUDA_SEPARABLE_COMPILATION ON)  # 可选
</code></pre>
<h4 id="cuda_3">创建 CUDA 项目</h4>
<p>完成以上选项的设定后，使用 <code>project</code> 命令正式创建 CUDA C++ 项目。</p>
<pre><code class="language-cmake">project(这里填你的项目名 LANGUAGES CXX CUDA)
</code></pre>
<blockquote>
<p><img src="../img/awesomeface.png" height="30px" width="auto" style="margin: 0; border: none"/> 我见过有人照抄代码把“这里填你的项目名”抄进去的。</p>
</blockquote>
<p>如需在特定条件下才开启 CUDA，可以用 <code>enable_language()</code> 命令延迟 CUDA 环境在 CMake 中的初始化：</p>
<pre><code class="language-cmake">project(这里填你的项目名 LANGUAGES CXX)

...

option(ENABLE_CUDA &quot;Enable CUDA&quot; ON)

if (ENABLE_CUDA)
    enable_language(CUDA)
endif()
</code></pre>
<h4 id="cmake_1">CMake 配置总结</h4>
<p>注意！以上这些选项设定都必须在 <code>project()</code> 命令之前！否则设定了也无效。</p>
<p>因为实际上是 <code>project()</code> 命令会检测这些选项，用这些选项来找到编译器和 CUDA 版本等信息。</p>
<p>总之，我的选项是：</p>
<pre><code class="language-cmake">cmake_minimum_required(VERSION 3.12)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CUDA_STANDARD 20)
set(CMAKE_CUDA_SEPARABLE_COMPILATION OFF)
set(CMAKE_CUDA_FLAGS &quot;${CMAKE_CUDA_FLAGS} --expt-relaxed-constexpr --expt-extended-lambda&quot;)
if (NOT DEFINED CMAKE_CUDA_ARCHITECTURES AND CMAKE_VERSION VERSION_GREATER_EQUAL 3.24)
    set(CMAKE_CUDA_ARCHITECTURES native)
endif()

project(你的项目名 LANGUAGES CXX CUDA)

file(GLOB sources &quot;*.cpp&quot; &quot;*.cu&quot;)
add_executable(${PROJECT_NAME} ${sources})
target_link_libraries(${PROJECT_NAME} PRIVATE cusparse cublas)
</code></pre>
<h2 id="cuda_4">开始编写 CUDA</h2>
<p>CUDA 有两套 API：</p>
<ul>
<li><a href="https://docs.nvidia.com/cuda/cuda-runtime-api/index.html">CUDA runtime API</a>：更加简单，兼顾性能，无需手动编译 kernel，都替你包办好了，但不够灵活。</li>
<li><a href="https://docs.nvidia.com/cuda/cuda-driver-api/index.html">CUDA driver API</a>：更加灵活多变，但操作繁琐，需要手动编译 kernel，适合有特殊需求的用户。</li>
</ul>
<p>他们都提供了大量用于管理 CUDA 资源和内存的函数。</p>
<p>我们要学习的是比较易懂、用的也最多的 CUDA runtime API。</p>
<p>使用 <code>&lt;cuda_runtime.h&gt;</code> 头文件即可导入所有 CUDA runtime API 的函数和类型：</p>
<pre><code class="language-cuda">#include &lt;cuda_runtime.h&gt;
</code></pre>
<blockquote>
<p><img src="../img/bulb.png" height="30px" width="auto" style="margin: 0; border: none"/> 虽然 CUDA 基于 C++（而不是 C 语言），支持所有 C++ 语言特性。但其 CUDA runtime API 依然是仿 C 风格的接口，可能是照顾了部分从 C 语言转过来的土木老哥，也可能是为了方便被第三方二次封装。</p>
</blockquote>
<p>TODO: 更多话题</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>小彭老师倾 ♥ 制作</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../js/print-site.js"></script>
        <script src="../extra.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
