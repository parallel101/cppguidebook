# å‡½æ•°å¼ç¼–ç¨‹

[TOC]

## ä¸ºä»€ä¹ˆéœ€è¦å‡½æ•°ï¼Ÿ

```cpp
int main() {
    std::vector<int> a = {1, 2, 3, 4};
    int s = 0;
    for (int i = 0; i < a.size(); i++) {
        s += a[i];
    }
    fmt::println("sum = {}", s);
    return 0;
}
```

è¿™æ˜¯ä¸€ä¸ªè®¡ç®—æ•°ç»„æ±‚å’Œçš„ç®€å•ç¨‹åºã€‚

ä½†æ˜¯ï¼Œä»–åªèƒ½è®¡ç®—æ•°ç»„ a çš„æ±‚å’Œï¼Œæ— æ³•å¤ç”¨ã€‚

å¦‚æœæˆ‘ä»¬æœ‰å¦ä¸€ä¸ªæ•°ç»„ b ä¹Ÿéœ€è¦æ±‚å’Œçš„è¯ï¼Œå°±å¾—æŠŠæ•´ä¸ªæ±‚å’Œçš„ for å¾ªç¯é‡æ–°å†™ä¸€éï¼š

```cpp
int main() {
    std::vector<int> a = {1, 2, 3, 4};
    int s = 0;
    for (int i = 0; i < a.size(); i++) {
        s += a[i];
    }
    fmt::println("sum of a = {}", s);
    std::vector<int> b = {5, 6, 7, 8};
    s = 0;
    for (int i = 0; i < a.size(); i++) {
        s += b[i];
    }
    fmt::println("sum of b = {}", s);
    return 0;
}
```

è¿™å°±å‡ºç°äº†ç¨‹åºè®¾è®¡çš„å¤§å¿Œï¼šä»£ç é‡å¤ã€‚

> {{ icon.fun }} ä¾‹å¦‚ï¼Œä½ æœ‰å¹ç©ºè°ƒçš„éœ€æ±‚ï¼Œå’Œå……æ‰‹æœºçš„éœ€æ±‚ã€‚ä½ ä¸ºäº†æ»¡è¶³è¿™ä¸¤ä¸ªéœ€æ±‚ï¼Œè´­ä¹°äº†ä¸¤å°å‘ç”µæœºï¼Œåˆ†åˆ«ä¸ºç©ºè°ƒå’Œæ‰‹æœºä¾›ç”µã€‚ç¬¬äºŒå¤©ï¼Œä½ åˆäº§ç”Ÿäº†ç©ç”µè„‘éœ€æ±‚ï¼Œäºæ˜¯ä½ åˆè´­ä¹°ä¸€å°å‘ç”µæœºï¼Œä¸“ä¸ºç”µè„‘ä¾›ç”µâ€¦â€¦çœŸæ˜¯æµªè´¹ï¼

é‡å¤çš„ä»£ç ä¸ä»…å½±å“ä»£ç çš„**å¯è¯»æ€§**ï¼Œä¹Ÿå¢åŠ äº†**ç»´æŠ¤**ä»£ç çš„æˆæœ¬ã€‚

+ çœ‹èµ·æ¥ä¹±ç³Ÿç³Ÿçš„ï¼Œä¿¡æ¯å¯†åº¦ä½ï¼Œè®©äººä¸€çœ¼çœ‹ä¸å‡ºä»£ç åœ¨å¹²ä»€ä¹ˆçš„åŠŸèƒ½
+ å¾ˆå®¹æ˜“å†™é”™ï¼Œçœ‹èµ°çœ¼ï¼Œéš¾è°ƒè¯•
+ å¤åˆ¶ç²˜è´´è¿‡ç¨‹ä¸­ï¼Œå®¹æ˜“æ¼æ”¹ï¼Œæ¯”å¦‚è¿™é‡Œçš„ `s += b[i]` å¯èƒ½å†™æˆ `s += a[i]` è€Œè‡ªå·±ä¸å‘ç°
+ æ”¹èµ·æ¥ä¸æ–¹ä¾¿ï¼Œå½“æˆ‘ä»¬çš„éœ€æ±‚å˜æ›´æ—¶ï¼Œéœ€è¦å¤šå¤„ä¿®æ”¹ï¼Œæ¯”å¦‚å½“æˆ‘éœ€è¦æ”¹ä¸ºè®¡ç®—ä¹˜ç§¯æ—¶ï¼Œéœ€è¦æŠŠä¸¤ä¸ªåœ°æ–¹éƒ½æ”¹æˆ `s *=`
+ æ”¹äº†ä»¥åå¯èƒ½æ¼æ”¹ä¸€éƒ¨åˆ†ï¼Œç•™ä¸‹ Bug éšæ‚£
+ æ•æ·å¼€å‘éœ€è¦åå¤ä¿®æ”¹ä»£ç ï¼Œæ¯”å¦‚ä½ æ­£åœ¨è°ƒè¯• `+=` å’Œ `-=` çš„åŒºåˆ«ï¼Œçœ‹ç»“æœå˜åŒ–ï¼Œå¦‚æœä¸€æ¬¡åˆ‡æ¢éœ€è¦æ”¹å¤šå¤„ï¼Œå°±å½±å“äº†è°ƒè¯•é€Ÿåº¦

### ç‹‚æƒ³ï¼šæ²¡æœ‰å‡½æ•°çš„ä¸–ç•Œï¼Ÿ

> {{ icon.story }} å¦‚æœä½ è¿˜æ˜¯å–œæ¬¢â€œä¸€æœ¬é“â€å†™æ³•çš„è¯ï¼Œä¸å¦¨æƒ³æƒ³çœ‹ï¼Œå®Œå…¨ä¸ç”¨ä»»ä½•æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åº“çš„å‡½æ•°å’Œç±»ï¼ŒæŠŠ `fmt::println` å’Œ `std::vector` è¿™äº›å‡½æ•°å…¨éƒ¨æ‹†è§£æˆä¸€ä¸ªä¸ªç³»ç»Ÿè°ƒç”¨ã€‚é‚£è¿™æ•´ä¸ªç¨‹åºä¼šæœ‰å¤šéš¾å†™ï¼Ÿ

```cpp
int main() {
#ifdef _WIN32
    int *a = (int *)VirtualAlloc(NULL, 4096, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
#else
    int *a = (int *)mmap(NULL, 4 * sizeof(int), PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);
#endif
    a[0] = 1;
    a[1] = 2;
    a[2] = 3;
    a[3] = 4;
    int s = 0;
    for (int i = 0; i < 4; i++) {
        s += a[i];
    }
    char buffer[64];
    buffer[0] = 's';
    buffer[1] = 'u';
    buffer[2] = 'm';
    buffer[3] = ' ';
    buffer[4] = '=';
    buffer[5] = ' '; // ä¾‹å¦‚ï¼Œå¦‚æœè¦ä¿®æ”¹æ­¤å¤„çš„æç¤ºæ–‡æœ¬ï¼Œç”šè‡³éœ€è¦ä¿®æ”¹åé¢çš„ len å˜é‡...
    int len = 6;
    int x = s;
    do {
        buffer[len++] = '0' + x % 10;
        x /= 10;
    } while (x);
    buffer[len++] = '\n';
#ifdef _WIN32
    WriteFile(GetStdHandle(STD_OUTPUT_HANDLE), buffer, len, NULL, NULL);
#else
    write(1, buffer, len);
#endif
    int *b = (int *)a;
    b[0] = 4;
    b[1] = 5;
    b[2] = 6;
    b[3] = 7;
    int s = 0;
    for (int i = 0; i < 4; i++) {
        s += b[i];
    }
    len = 6;
    x = s;
    do {
        buffer[len++] = '0' + x % 10;
        x /= 10;
    } while (x);
    buffer[len++] = '\n';
#ifdef _WIN32
    WriteFile(GetStdHandle(STD_OUTPUT_HANDLE), buffer, len, NULL, NULL);
#else
    write(1, buffer, len);
#endif
#ifdef _WIN32
    VirtualFree(a, 0, MEM_RELEASE);
#else
    munmap(a);
#endif
    return 0;
}
```

ä¸ä»…å®Œå…¨æ²¡æœ‰å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ï¼Œç”šè‡³éƒ½æ²¡æœ‰å¯ç§»æ¤æ€§ã€‚

é™¤éä½ åªå†™åº”ä»˜å¯¼å¸ˆçš„â€œä¸€æ¬¡æ€§â€ç¨‹åºï¼Œä¸€æ—¦è¦å®ç°å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ï¼Œä¸å¯é¿å…çš„è¦è‡ªå·±å°è£…å‡½æ•°æˆ–ç±»ã€‚ç½‘ä¸Šæ‰€æœ‰é¼“å¹â€œä¸å°è£…â€â€œè®¾è®¡æ¨¡å¼æ˜¯é¢å­å·¥ç¨‹â€çš„åæ™ºè¨€è®ºï¼Œéƒ½æ˜¯æ²¡æœ‰åšè¿‡å¤§å‹é¡¹ç›®çš„ã€‚


### è®¾è®¡æ¨¡å¼è¿½æ±‚çš„æ˜¯â€œå¯æ”¹â€è€Œä¸æ˜¯â€œå¯è¯»â€ï¼

å¾ˆå¤šè®¾è®¡æ¨¡å¼æ•™æç‰‡é¢å¼ºè°ƒ**å¯è¯»æ€§**ï¼Œä»¿ä½›è®¾è®¡æ¨¡å¼å°±æ˜¯ä¸ºäº†â€œä¼˜é›…â€â€œé«˜å¤§ä¸Šâ€â€œç¾å­¦â€ï¼Ÿä½¿å¾—å¾ˆå¤šäººè®¤ä¸ºï¼Œâ€œæˆ‘è¿™ä¸ªæ˜¯è‡ªå·±çš„é¡¹ç›®ï¼Œä¸ç”¨ç¾åŒ–ç»™é¢†å¯¼çœ‹â€è€Œæ‹’ç»è®¾è®¡æ¨¡å¼ã€‚å®é™…ä¸Šè®¾è®¡æ¨¡å¼çš„ä¸»è¦ä»·å€¼åœ¨äº*æ–¹ä¾¿åç»­ä¿®æ”¹**ï¼

> {{ icon.fun }} ä¾‹å¦‚ B ç«™ä»¥å‰åªæ”¯æŒä¸Šä¼ æ™®é€šè§†é¢‘ï¼Œç°åœ¨å”å”çªç„¶æå‡ºï¼šè¦æ”¯æŒäº’åŠ¨è§†é¢‘ï¼Œå……ç”µè§†é¢‘ï¼Œè§†é¢‘åˆé›†ï¼Œè¿˜åºŸé™¤äº†è§†é¢‘åˆ† pï¼Œè¿˜è¦æ”¯æŒä¸Šä¼ çŸ­è§†é¢‘ï¼Œç«–å±å¼€å…³ç­‰â€¦â€¦æ¯ä¸€ä¸ªå”å”çš„è¦æ±‚ï¼Œéƒ½éœ€è¦å¤§é‡ç¨‹åºå‘˜ä¿®æ”¹ä»£ç ï¼Œæ— è®ºæ¶‰åŠå‰ç«¯è¿˜æ˜¯åç«¯ã€‚

ä¸å»ºç­‘ã€ç»˜ç”»ç­‰é¢†åŸŸä¸åŒï¼Œä¸€æ¬¡äº¤ä»˜å®Œæ¯•å°±å¯ä»¥å‡ ä¹æ°¸ä¹…ä½¿ç”¨ã€‚è€Œè½¯ä»¶å¼€å‘æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œæ¯æ¬¡éœ€æ±‚å˜æ›´ï¼Œéƒ½å¯¼è‡´ä»£ç éœ€è¦ä¿®æ”¹ã€‚å¼€å‘äººå‘˜å‡ ä¹éœ€è¦ä¸€ç›´å›´ç»•ç€è½¯ä»¶ä»£ç ï¼Œä¸æ–­çš„ä¿®æ”¹ã€‚è°ƒæŸ¥è¡¨æ˜ï¼Œç¨‹åºå‘˜ 90% çš„æ—¶é—´èŠ±åœ¨**æ”¹ä»£ç **ä¸Šï¼Œ**å†™ä»£ç **åªå  10%ã€‚

> {{ icon.fun }} è½¯ä»¶å°±åƒç”Ÿç‰©ï¼Œè¦ä¸æ–­è¿›åŒ–ï¼Œè½¯ä»¶ä¸æ›´æ–°ä¸ç»´æŠ¤äº†ç­‰äºæ­»ã€‚å¦‚æœä¸€ä¸ªè½¯ä»¶é€æ¸å˜å¾—è‡ƒè‚¿éš¾ä»¥ä¿®æ”¹ï¼Œæ— æ³•é€‚åº”æ–°éœ€æ±‚ï¼Œé‚£ä»–å°±åƒå·²ç»å¤±å»è¿›åŒ–èƒ½åŠ›çš„ç”Ÿç‰©ç§ç¾¤ï¼Œå¦‚ã€Šä¸‰ä½“ã€‹ä¸–ç•Œè§‚ä¸­â€œå®‰é¡¿â€åˆ°æ¾³å¤§åˆ©äºšä¿ç•™åŒºé‡Œâ€œç»è‚²â€çš„äººç±»ï¼Œè¢«æ·˜æ±°åªæ˜¯æ—¶é—´é—®é¢˜ã€‚

å¦‚æœæˆ‘ä»¬èƒ½åœ¨**å†™ä»£ç **é˜¶æ®µï¼Œå°±æŠŠç¨‹åºå‡†å¤‡å¾—**æ˜“äºåç»­ä¿®æ”¹**ï¼Œé‚£å°±å¯ä»¥åœ¨åç»­ 90% çš„**æ”¹ä»£ç **é˜¶æ®µçœä¸‹æ— æ•°æ—¶é—´ã€‚

å¦‚ä½•è®©ä»£ç æ˜“äºä¿®æ”¹ï¼Ÿå‰äººæ€»ç»“å‡ºä¸€ç³»åˆ—å¸¸ç”¨çš„å†™æ³•ï¼Œè¿™ç±»å†™æ³•æœ‰åŠ©äºè®©åç»­ä¿®æ”¹æ›´å®¹æ˜“ï¼Œå„è‡ªé€‚ç”¨äºä¸åŒçš„åœºåˆï¼Œè¿™å°±æ˜¯è®¾è®¡æ¨¡å¼ã€‚

æå‡å¯ç»´æŠ¤æ€§æœ€åŸºç¡€çš„ä¸€ç‚¹ï¼Œå°±æ˜¯é¿å…é‡å¤ï¼

å½“ä½ æœ‰å¾ˆå¤šåœ°æ–¹å‡ºç°é‡å¤çš„ä»£ç æ—¶ï¼Œä¸€æ—¦éœ€è¦æ¶‰åŠä¿®æ”¹è¿™éƒ¨åˆ†é€»è¾‘æ—¶ï¼Œå°±éœ€è¦åˆ°æ¯ä¸€ä¸ªå‡ºç°äº†è¿™ä¸ªé€»è¾‘çš„ä»£ç ä¸­ï¼Œå»é€ä¸€ä¿®æ”¹ã€‚

> {{ icon.fun }} ä¾‹å¦‚ä½ çš„åå­—ï¼Œåœ¨å‡ºç”Ÿè¯ï¼Œèº«ä»½è¯ï¼Œå­¦ç”Ÿè¯ï¼Œæ¯•ä¸šè¯ï¼Œæˆ¿äº§è¯ï¼Œé©¾é©¶è¯ï¼Œå„ç§åœ°æ–¹éƒ½å‡ºç°äº†ã€‚é‚£ä¹ˆä½ è¦æ”¹åçš„è¯ï¼Œæ‰€æœ‰è¿™äº›è¯ä»¶éƒ½éœ€è¦é‡æ–°å°åˆ·ï¼å¦‚æœèƒ½æŠŠä»–ä»¬åˆå¹¶æˆä¸€ä¸ªâ€œç»Ÿä¸€è¯â€ï¼Œé‚£ä¹ˆåªéœ€è¦ä¿®æ”¹â€œç»Ÿä¸€è¯â€ä¸Šçš„åå­—å°±è¡Œäº†ã€‚

ä¸è¿‡ï¼Œç°å®ä¸­å¹¶æ²¡æœ‰é¢‘ç¹æ”¹åå­—çš„éœ€æ±‚ï¼Œè¿™è¯´æ˜ï¼š

- å¯¹äºä¸å¸¸ä¿®æ”¹çš„ä¸œè¥¿ï¼Œå¯ä»¥å®¹å¿ä¸€å®šçš„é‡å¤ã€‚
- è¶Šæ˜¯æœªæ¥æœ‰å¯èƒ½ä¿®æ”¹çš„ï¼Œå°±è¶Šéœ€è¦è®¾è®¡æ¨¡å¼é™é‡ï¼

ä¾‹å¦‚æ•°å­¦å¸¸æ•° PI = 3.1415926535897ï¼Œè¿™è¾ˆå­éƒ½ä¸å¯èƒ½å‡ºç°ä¿®æ”¹çš„éœ€æ±‚ï¼Œé‚£å†™æ­»ä¹Ÿæ²¡å…³ç³»ã€‚å¦‚æœè¦æŠŠ PI å®šä¹‰æˆå®ï¼Œåªæ˜¯å‡ºäºâ€œè®°ä¸ä½â€â€œå†™èµ·æ¥å¤ªé•¿äº†â€â€œå¤åˆ¶ç²˜è´´éº»çƒ¦â€ã€‚æ‰€ä»¥å¯¹äº PI è¿™ç§ä¸ä¼šä¿®æ”¹çš„ä¸œè¥¿ï¼Œé™é‡åªæ˜¯å¢åŠ **å¯è¯»æ€§**ï¼Œè€Œä¸æ˜¯**å¯ä¿®æ”¹æ€§**ã€‚

> {{ icon.tip }} ä½†æ˜¯ï¼Œä¸è¦æƒ³å½“ç„¶ï¼éœ€æ±‚çš„åƒå˜ä¸‡åŒ–æ€»æ˜¯è¶…å‡ºä½ çš„æƒ³è±¡ã€‚

ä¾‹å¦‚ä½ åšäº†ä¸€ä¸ªâ€œæ„¤æ€’çš„å°é¸Ÿâ€æ¸¸æˆï¼Œéœ€è¦ç”¨åˆ°é‡åŠ›åŠ é€Ÿåº¦ g = 9.8ï¼Œä½ æƒ³å½“ç„¶è®¤ä¸º g ä»¥åä¸å¯èƒ½ä¿®æ”¹ã€‚è€æ¿ä¹Ÿä¿¡èª“æ—¦æ—¦å‘ä½ ä¿è¯ï¼šâ€œæ²¡äº‹ï¼Œé‡åŠ›åŠ é€Ÿåº¦ä¸ä¼šæ”¹å˜ã€‚â€ä½ å°±å†™æ­»åœ¨ä»£ç é‡Œäº†ã€‚

æ²¡æƒ³åˆ°ï¼Œâ€œæ„¤æ€’çš„å°é¸Ÿâ€è€æ¿çªç„¶è¦æ±‚ä½ åŠ å…¥â€œæœˆçƒç« â€å…³å¡ï¼Œåœ¨è¿™äº›å…³å¡ä¸­ï¼Œé‡åŠ›åŠ é€Ÿåº¦æ˜¯ g = 1.6ã€‚

å¦‚æœä½ ä¸€å¼€å§‹å°±å·²ç»æŠŠ g æå–å‡ºæ¥ï¼Œå®šä¹‰ä¸ºå¸¸é‡ï¼š

```cpp
struct Level {
    const double g = 9.8;

    void physics_sim() {
        bird.v = g * t; // å‡è£…è¿™é‡Œæ˜¯ç‰©ç†ä»¿çœŸç¨‹åº
        pig.v = g * t;  // å‡è£…è¿™é‡Œæ˜¯ç‰©ç†ä»¿çœŸç¨‹åº
    }
};
```

é‚£ä¹ˆè¦æ”¯æŒæœˆçƒå…³å¡ï¼Œåªéœ€ä¿®æ”¹ä¸€å¤„å°±å¯ä»¥äº†ã€‚

```cpp
struct Level {
    double g;

    Level(Chapter chapter) {
        if (chapter == ChapterMoon) {
            g = 1.6;
        } else {
            g = 9.8;
        }
    }

    void physics_sim() {
        bird.v = g * t; // æ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œè‡ªåŠ¨é€‚åº”äº†æ–°çš„éå¸¸æ•° g
        pig.v = g * t;  // æ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œè‡ªåŠ¨é€‚åº”äº†æ–°çš„éå¸¸æ•° g
    }
};
```

> {{ icon.fun }} å°å½­è€å¸ˆä¹‹å‰åš zeno æ—¶ï¼Œè¯¢é—®è¦ä¸è¦æŠŠæ¸²æŸ“ç®¡çº¿èŠ‚ç‚¹åŒ–ï¼Œæ–¹ä¾¿ç”¨æˆ·åŠ¨æ€ç¼–ç¨‹ï¼Ÿå¼ çŒ©çŒ©å°±æ˜¯ä¿¡èª“æ—¦æ—¦é“ï¼šâ€œæ¸²æŸ“æ˜¯ä¸€ä¸ªé«˜åº¦æˆç†Ÿé¢†åŸŸï¼Œä¸ä¼šæœ‰å¤šå°‘ä¿®æ”¹éœ€æ±‚çš„ã€‚â€å°å½­è€å¸ˆé‚å†™æ­»äº†æ¸²æŸ“ç®¡çº¿ï¼Œä¸“ä¸ºæ€§èƒ½æåº¦ä¼˜åŒ–ï¼Œå‡ ä¸ªæœˆåï¼Œå¼ çŒ©çŒ©ç¾ç­”ç­”æ‰¾åˆ°å°å½­è€å¸ˆï¼šâ€œå°å½­è€å¸ˆï¼Œé‚£ä¸ªï¼Œæ¸²æŸ“ï¼Œèƒ½ä¸èƒ½æ”¹æˆèŠ‚ç‚¹å•Šâ€¦â€¦â€ã€‚è¿™ä¸ªæ•…äº‹å‘Šè¯‰æˆ‘ä»¬ï¼Œç”²æ–¹çš„ä¿¡èª“æ—¦æ—¦æ”¾çš„ä¸€ä¸ªå±éƒ½ä¸èƒ½ä¿¡ã€‚

### ç”¨å‡½æ•°å°è£…

å‡½æ•°å°±æ˜¯æ¥å¸®ä½ è§£å†³ä»£ç é‡å¤é—®é¢˜çš„ï¼è¦é¢†ï¼š

**æŠŠå…±åŒçš„éƒ¨åˆ†æå–å‡ºæ¥ï¼ŒæŠŠä¸åŒçš„éƒ¨åˆ†ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚**

```cpp
void sum(std::vector<int> const &v) {
    int s = 0;
    for (int i = 0; i < v.size(); i++) {
        s += v[i];
    }
    fmt::println("sum of v = {}", s);
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    sum(a);
    std::vector<int> b = {5, 6, 7, 8};
    sum(b);
    return 0;
}
```

è¿™æ · main å‡½æ•°é‡Œå°±å¯ä»¥åªå…³å¿ƒè¦æ±‚å’Œçš„æ•°ç»„ï¼Œè€Œä¸ç”¨å…³å¿ƒæ±‚å’Œå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„äº†ã€‚äº‹åæˆ‘ä»¬å¯ä»¥éšæ—¶æŠŠ sum çš„å†…å®¹å·å·æ¢æ‰ï¼Œæ¢æˆå¹¶è¡Œçš„ç®—æ³•ï¼Œmain ä¹Ÿä¸ç”¨çŸ¥é“ã€‚è¿™å°±æ˜¯**å°è£…**ï¼Œå¯ä»¥æŠŠé‡å¤çš„å…¬å…±éƒ¨åˆ†æŠ½å–å‡ºæ¥ï¼Œæ–¹ä¾¿ä»¥åä¿®æ”¹ä»£ç ã€‚

> {{ icon.fun }} sum å‡½æ•°ç›¸å½“äºï¼Œå½“éœ€è¦å¹ç©ºè°ƒæ—¶ï¼Œæ’ä¸Šç©ºè°ƒæ’åº§ã€‚å½“éœ€è¦ç»™æ‰‹æœºå……ç”µæ—¶ï¼Œæ’ä¸Šæ‰‹æœºå……ç”µå™¨ã€‚ä½ ä¸éœ€è¦å…³å¿ƒæ’åº§é‡Œçš„ç”µå“ªé‡Œæ¥ï¼Œâ€œå›½å®¶ç”µç½‘â€ä¼šæ›¿ä½ æƒ³åŠæ³•è§£å†³ï¼Œæƒ³åŠæ³•ä¼˜åŒ–ï¼Œæƒ³åŠæ³•å‡çº§åˆ°ç»¿è‰²èƒ½æºã€‚ä½ åªéœ€è¦å¹ç€ç©ºè°ƒç»™ä½ æ­£åœ¨å¼€å‘çš„æ‰‹æœº App ä¼˜åŒ–å°±è¡Œäº†ï¼Œå¤§å¤§å‡è½»ç¨‹åºå‘˜å¿ƒæ™ºè´Ÿæ‹…ã€‚

### è¦å°è£…ï¼Œä½†ä¸è¦è€¦åˆ

ä½†æ˜¯ï¼è¿™æ®µä»£ç ä»ç„¶æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æŠŠ sum æ±‚å’Œçš„ç»“æœï¼Œç›´æ¥åœ¨ sum é‡Œæ‰“å°äº†å‡ºæ¥ã€‚sum é‡Œå†™æ­»äº†ï¼Œæ±‚å®Œå’Œä¹‹ååªèƒ½ç›´æ¥æ‰“å°ï¼Œè°ƒç”¨è€… main æ ¹æœ¬æ— æ³•æ§åˆ¶ã€‚

è¿™æ˜¯ä¸€ç§é”™è¯¯çš„å°è£…ï¼Œæˆ–è€…è¯´ï¼Œå°è£…è¿‡å¤´äº†ã€‚

> {{ icon.fun }} ä½ æŠŠæ‰‹æœºå……ç”µå™¨ (fmt::println) ç„Šæ­»åœ¨äº†æ’åº§ (sum) ä¸Šï¼Œç°åœ¨è¿™ä¸ªæ’åº§åªèƒ½ç»™æ‰‹æœºå……ç”µ (ç”¨äºç›´æ¥æ‰“å°) äº†ï¼Œä¸èƒ½ç»™ç¬”è®°æœ¬ç”µè„‘å……ç”µ (æ±‚å’Œç»“æœä¸ç›´æ¥ç”¨äºæ‰“å°) äº†ï¼å°½ç®¡é€šè¿‡æ›´æ¢å……ç”µçº¿ (å‚æ•° v)ï¼Œè¿˜å¯ä»¥æ”¯æŒæ”¯æŒå®‰å“ (a) å’Œè‹¹æœ (b) ä¸¤ç§æ‰‹æœºçš„å……ç”µï¼Œä½†è¿™æ ·ç„Šæ­»çš„æ’åº§å·²ç»å’Œç¬”è®°æœ¬ç”µè„‘æ— ç¼˜äº†ã€‚

### æ¯ä¸ªå‡½æ•°åº”è¯¥èŒè´£å•ä¸€ï¼Œåˆ«ä¸€å¿ƒå¤šç”¨

å¾ˆæ˜æ˜¾ï¼Œâ€œæ‰“å°â€å’Œâ€œæ±‚å’Œâ€æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ“ä½œï¼Œä¸åº”è¯¥ç„Šæ­»åœ¨ä¸€å—ã€‚

sum å‡½æ•°çš„æœ¬èŒå·¥ä½œæ˜¯â€œæ•°ç»„æ±‚å’Œâ€ï¼Œä¸åº”è¯¥é™„èµ æ‰“å°åŠŸèƒ½ã€‚

sum è®¡ç®—å‡ºæ±‚å’Œç»“æœåï¼Œç›´æ¥ return å³å¯ã€‚

> {{ icon.fun }} å¦‚ä½•å¤„ç†è¿™ä¸ªç»“æœï¼Œæ˜¯è°ƒç”¨è€… main çš„äº‹ï¼Œæ­£å¦‚â€œå›½å®¶ç”µç½‘â€ä¸ä¼šç®¡ä½ ç”¨ä»–æä¾›çš„ç”µæ¥å¹ç©ºè°ƒè¿˜æ˜¯ç©æ¸¸æˆä¸€æ ·ï¼Œåªè¦ä¸å¦¨ç¢åˆ°å…¶ä»–å±…æ°‘çš„æ­£å¸¸ç”¨ç”µã€‚

```cpp
int sum(std::vector<int> const &v) {
    int s = 0;
    for (int i = 0; i < v.size(); i++) {
        s += v[i];
    }
    return s;
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    fmt::println("sum of a = {}", sum(a));
    std::vector<int> b = {5, 6, 7, 8};
    fmt::println("sum of b = {}", sum(b));
    return 0;
}
```

è¿™å°±æ˜¯è®¾è®¡æ¨¡å¼æ‰€è¯´çš„**èŒè´£å•ä¸€åŸåˆ™**ã€‚

### äºŒæ¬¡å°è£…

å‡è®¾æˆ‘ä»¬è¦è®¡ç®—ä¸€ä¸ªæ•°ç»„çš„å¹³å‡å€¼ï¼Œå¯ä»¥å†å®šä¹‰ä¸ªå‡½æ•° averageï¼Œä»–å¯ä»¥åŸºäº sum å®ç°ï¼š

```cpp
int sum(std::vector<int> const &v) {
    int s = 0;
    for (int i = 0; i < v.size(); i++) {
        s += v[i];
    }
    return s;
}

double average(std::vector<int> const &v) {
    return (double)sum(v) / v.size();
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    fmt::println("average of a = {}", average(a));
    std::vector<int> b = {5, 6, 7, 8};
    fmt::println("average of b = {}", average(b));
    return 0;
}
```

è¿›ä¸€æ­¥å°è£…ä¸€ä¸ªæ‰“å°æ•°ç»„æ‰€æœ‰ç»Ÿè®¡å­¦ä¿¡æ¯çš„å‡½æ•°ï¼š

```cpp
void print_statistics(std::vector<int> const &v) {
    if (v.empty()) {
        fmt::println("this is empty...");
    } else {
        fmt::println("sum: {}", sum(v));
        fmt::println("average: {}", average(v));
        fmt::println("min: {}", min(v));
        fmt::println("max: {}", max(v));
    }
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    print_statistics(a);
    std::vector<int> b = {5, 6, 7, 8};
    print_statistics(b);
    return 0;
}
```

æš´éœ² API æ—¶ï¼Œè¦åŒæ—¶æä¾›åº•å±‚çš„ API å’Œé«˜å±‚å°è£…çš„ APIã€‚ç”¨æˆ·å¦‚æœæƒ³è¦æ§åˆ¶æ›´å¤šç»†èŠ‚å¯ä»¥è°ƒç”¨åº•å±‚ APIï¼Œæƒ³è¦çœäº‹çš„ç”¨æˆ·å¯ä»¥è°ƒç”¨é«˜å±‚å°è£…å¥½çš„ APIã€‚

> {{ icon.tip }} é«˜å±‚å°è£… API åº”å½“å¯ä»¥å®Œå…¨é€šè¿‡è°ƒç”¨åº•å±‚ API å®ç°ï¼Œæä¾›é«˜å±‚ API åªæ˜¯æ–¹ä¾¿åˆçº§ç”¨æˆ·ä½¿ç”¨å’Œç†è§£ã€‚

> {{ icon.story }} 
    ä¾‹å¦‚ `libcurl` å°±æä¾›äº† `curl_easy` å’Œ `curl_multi` ä¸¤å¥— APIã€‚

    - `curl_multi` æä¾›äº†è¶…è¯¦ç»†çš„å‚æ•°ï¼ŒæŠŠæ¯ä¸ªæ“ä½œåˆ†æ‹†æˆå¤šæ­¥ï¼Œæ–¹ä¾¿ç”¨æˆ·æ’æ‰‹ç»†èŠ‚ï¼Œæ»¡è¶³é«˜çº§ç”¨æˆ·çš„å®šåˆ¶åŒ–éœ€æ±‚ï¼Œä½†å¤ªè¿‡å¤æ‚ï¼Œéš¾ä»¥å­¦ä¹ ã€‚
    - `curl_easy` æ˜¯å¯¹ `curl_multi` çš„å†å°è£…ï¼Œæä¾›äº†æ›´ç®€å•çš„ APIï¼Œä½†æ˜¯å¯¹å…·ä½“ç»†èŠ‚å°±éš¾ä»¥æ“æ§äº†ï¼Œé€‚åˆåˆå­¦è€…ä¸Šæ‰‹ã€‚


### Linus çš„æœ€ä½³å®è·µï¼šæ¯ä¸ªå‡½æ•°ä¸è¦è¶…è¿‡ 3 å±‚åµŒå¥—ï¼Œå‡½æ•°ä½“ä¸è¦è¶…è¿‡ 24 è¡Œ

Linux å†…æ ¸ä¸ºä»€ä¹ˆåšæŒä½¿ç”¨ `TAB=8` ä¸ºä»£ç é£æ ¼ï¼Ÿ

TODOï¼šè¿˜åœ¨å†™

## ä¸ºä»€ä¹ˆéœ€è¦å‡½æ•°å¼ï¼Ÿ

ä½ äº§ç”Ÿäº†ä¸¤ä¸ªéœ€æ±‚ï¼Œåˆ†åˆ«å°è£…äº†ä¸¤ä¸ªå‡½æ•°ï¼š

- `sum` æ±‚æ‰€æœ‰å…ƒç´ çš„å’Œ
- `product` æ±‚æ‰€æœ‰å…ƒç´ çš„ç§¯

```cpp
int sum(std::vector<int> const &v) {
    int ret = v[0];
    for (int i = 1; i < v.size(); i++) {
        ret += v[i];
    }
    return ret;
}

int product(std::vector<int> const &v) {
    int ret = v[0];
    for (int i = 1; i < v.size(); i++) {
        ret *= v[i];
    }
    return ret;
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    fmt::println("sum: {}", sum(a));
    fmt::println("product: {}", product(a));
    return 0;
}
```

æ³¨æ„åˆ° `sum` å’Œ `product` çš„å†…å®¹å‡ ä¹å¦‚å‡ºä¸€è¾™ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼š

- `sum` çš„å¾ªç¯ä½“ä¸º `+=`ï¼›
- `product` çš„å¾ªç¯ä½“ä¸º `*=`ã€‚

è¿™ç§å‡½æ•°ä½“å†…æœ‰éƒ¨åˆ†ä»£ç é‡å¤ï¼Œä½†åˆæœ‰ç‰¹å®šéƒ¨åˆ†ä¸åŒï¼Œéš¾ä»¥æŠ½ç¦»ã€‚

è¯¥æ€ä¹ˆå¤ç”¨è¿™é‡å¤çš„éƒ¨åˆ†ä»£ç å‘¢ï¼Ÿ

æˆ‘ä»¬è¦æŠŠ `sum` å’Œ `product` åˆå¹¶æˆä¸€ä¸ªå‡½æ•° `generic_sum`ã€‚ç„¶åé€šè¿‡å‡½æ•°å‚æ•°ï¼ŒæŠŠå·®å¼‚éƒ¨åˆ†ï¼ˆ0ã€`+=`ï¼‰â€œæ³¨å…¥â€åˆ°ä¸¤ä¸ªå‡½æ•°åŸæœ¬ä¸åŒåœ°æ–¹ã€‚

### æšä¸¾çš„ç³Ÿç³•ç”¨æ³•

å¦‚ä½•è¡¨ç¤ºæˆ‘è¿™ä¸ªå‡½æ•°æ˜¯è¦åšæ±‚å’Œ `+=` è¿˜æ˜¯æ±‚ç§¯ `*=`ï¼Ÿ

è®©æˆ‘ä»¬å®šä¹‰æšä¸¾ï¼š

```cpp
enum Mode {
    ADD, // æ±‚å’Œæ“ä½œ
    MUL, // æ±‚ç§¯æ“ä½œ
};

int generic_sum(std::vector<int> const &v, Mode mode) {
    int ret = v[0];
    for (int i = 1; i < v.size(); i++) {
        if (mode == ADD) { // å‡½æ•°å†…åˆ¤æ–­æšä¸¾ï¼Œå†³å®šè¦åšä»€ä¹ˆæ“ä½œ
            ret += v[i];
        } else if (mode == MUL) {
            ret *= v[i];
        }
    }
    return ret;
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    fmt::println("sum: {}", generic_sum(a, ADD)); // ç”¨æˆ·æŒ‡å®šä»–æƒ³è¦çš„æ“ä½œ
    fmt::println("product: {}", generic_sum(a, MUL));
    return 0;
}
```

ç„¶è€Œï¼Œå¦‚æœç”¨æˆ·ç°åœ¨æƒ³è¦æ±‚æ•°ç»„çš„**æœ€å¤§å€¼**å‘¢ï¼Ÿ

æšä¸¾ä¸­è¿˜æ²¡æœ‰å®ç°æœ€å¤§å€¼çš„æ“ä½œâ€¦â€¦è¦æ”¯æŒï¼Œå°±å¾—æ‰‹å¿™è„šä¹±åœ°å»ä¿®æ”¹ `generic_sum` å‡½æ•°å’Œ `Mode` æšä¸¾åŸæœ¬çš„å®šä¹‰ï¼ŒçœŸéº»çƒ¦ï¼

```cpp
enum Mode {
    ADD,
    MUL,
    MAX, // ***æ”¹***
};

int generic_sum(std::vector<int> const &v, Mode mode) {
    int ret = v[0];
    for (int i = 1; i < v.size(); i++) {
        if (mode == ADD) {
            ret += v[i];
        } else if (mode == MUL) {
            ret *= v[i];
        } else if (mode == MAX) { // ***æ”¹***
            ret = std::max(ret, v[i]); // ***æ”¹***
        }
    }
    return ret;
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    generic_sum(a, MAX); // ***æ”¹***
    return 0;
}
```

> {{ icon.tip }} æˆ‘ç”¨ `// ***æ”¹***` æŒ‡ç¤ºäº†æ‰€æœ‰éœ€è¦æ”¹åŠ¨çš„åœ°æ–¹ã€‚

ä¸ºäº†å¢åŠ ä¸€ä¸ªæ±‚æœ€å¤§å€¼çš„æ“ä½œï¼Œå°±éœ€è¦ä¸‰å¤„åˆ†æ•£åœ¨å„åœ°çš„æ”¹åŠ¨ï¼

ä¸ä»…å¦‚æ­¤ï¼Œè¿˜å®¹æ˜“æŠ„æ¼ï¼ŒæŠ„é”™ï¼Œæ¯”å¦‚ `MAX` ä¸å°å¿ƒæ‰“é”™æˆ `MUL` äº†ï¼Œè‡ªå·±å´æ²¡å‘ç°ï¼Œç•™ä¸‹ BUG éšæ‚£ã€‚

è¿™æ ·å†™ä»£ç çš„æ–¹å¼ï¼Œå¿ƒæ™ºè´Ÿæ‹…æå¤§ï¼Œæ•´å¤©å°±æå¿ƒåŠèƒ†ç€ä¸œä¸€å—ï¼Œè¥¿ä¸€å—çš„æ•£è£…ä»£ç ï¼Œæ‹…å¿ƒç€æœ‰æ²¡æœ‰å“ªä¸ªåœ°æ–¹å†™é”™å†™æ¼ï¼Œä¸¥é‡å¦¨ç¢äº†å¼€å‘æ•ˆç‡ã€‚

å¹¶ä¸”å†™å‡ºæ¥çš„ä»£ç ä¹Ÿä¸èƒ½é€‚åº”éœ€æ±‚çš„å˜åŒ–ï¼šå‡å¦‚æˆ‘éœ€è¦æ”¯æŒ `MIN` å‘¢ï¼Ÿåˆå¾—æ”¹ä¸‰ä¸ªåœ°æ–¹ï¼è¿™è¿èƒŒäº†è®¾è®¡æ¨¡å¼çš„**å¼€é—­åŸåˆ™**ã€‚

* å¼€é—­åŸåˆ™: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ã€‚æŒ‡çš„æ˜¯è½¯ä»¶åœ¨é€‚åº”éœ€æ±‚å˜åŒ–æ—¶ï¼Œåº”å°½é‡é€šè¿‡**æ‰©å±•ä»£ç *æ¥å®ç°å˜åŒ–ï¼Œè€Œä¸æ˜¯é€šè¿‡*ä¿®æ”¹å·²æœ‰ä»£ç **æ¥å®ç°å˜åŒ–ã€‚

ä½¿ç”¨æšä¸¾å’Œ if-else å®ç°å¤šæ€ï¼Œéš¾ä»¥æ‰©å±•ï¼Œè¿˜è¦ä¸€ç›´å»ä¿®æ”¹åŸå‡½æ•°çš„åº•å±‚å®ç°ï¼Œå°±è¿èƒŒäº†**å¼€é—­åŸåˆ™**ã€‚

### å‡½æ•°å¼ç¼–ç¨‹å…‰è£æ•‘åœº

å¦‚æœæˆ‘ä»¬å¯ä»¥â€œæ³¨å…¥â€ä»£ç å°±å¥½äº†ï¼èƒ½å¦æŠŠä¸€æ®µâ€œä»£ç â€ä½œä¸º `generic_sum` å‡½æ•°çš„å‚æ•°å‘¢ï¼Ÿ

ä»£ç ï¼Œå®é™…ä¸Šå°±æ˜¯å‡½æ•°ï¼Œæ³¨å…¥ä»£ç å°±æ˜¯æ³¨å…¥å‡½æ•°ã€‚æˆ‘ä»¬å…ˆå®šä¹‰å‡ºä¸‰ä¸ªä¸åŒæ“ä½œå¯¹åº”çš„å‡½æ•°ï¼š

```cpp
int add(int a, int b) {
    return a + b;
}

int mul(int a, int b) {
    return a * b;
}

int max(int a, int b) {
    return std::max(a, b);
}
```

ç„¶åï¼ŒæŠŠè¿™ä¸‰ä¸ªå°å‡½æ•°ï¼Œä½œä¸ºå¦ä¸€ä¸ªå¤§å‡½æ•° `generic_sum` çš„å‚æ•°å°±è¡Œï¼

```cpp
int generic_sum(std::vector<int> const &v, auto op) {
    int ret = v[0];
    for (int i = 1; i < v.size(); i++) {
        // å‡½æ•°ä½œè€…æ— éœ€äº†è§£ç”¨æˆ·æŒ‡å®šçš„â€œæ“ä½œâ€å…·ä½“æ˜¯ä»€ä¹ˆ
        // åªéœ€è¦è°ƒç”¨è¿™ä¸€â€œæ“ä½œâ€ï¼Œå¾—åˆ°ç»“æœå°±è¡Œ
        ret = op(ret, v[i]);
    }
    return ret;
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    // ç”¨æˆ·æ— éœ€å…³å¿ƒå‡½æ•°çš„å…·ä½“å®ç°æ˜¯ä»€ä¹ˆ
    // åªéœ€éšå¿ƒæ‰€æ¬²æŒ‡å®šä»–çš„â€œæ“ä½œâ€ä½œä¸ºå‚æ•°
    generic_sum(a, add);
    generic_sum(a, product);
    generic_sum(a, max);
    return 0;
}
```

è´£ä»»æ˜ç¡®äº†ï¼Œæˆ‘ä»¬æˆåŠŸæŠŠä¸€éƒ¨åˆ†ç»†èŠ‚ä» `generic_sum` ä¸­è¿›ä¸€æ­¥æŠ½ç¦»ã€‚

- åº“ä½œè€… `generic_sum` ä¸å¿…äº†è§£ `main` çš„æ“ä½œå…·ä½“æ˜¯ä»€ä¹ˆï¼Œä»–åªè´Ÿè´£åˆ©ç”¨è¿™ä¸ªæ“ä½œæ±‚â€œå’Œâ€ã€‚
- åº“ç”¨æˆ· `main` ä¸å¿…äº†è§£ `generic_sum` å¦‚ä½•å®ç°æ“ä½œç´¯åŠ ï¼Œä»–åªç®¡æ³¨å…¥â€œå¦‚ä½•æ“ä½œâ€çš„ä»£ç ï¼Œä»¥å‡½æ•°çš„å½¢å¼ã€‚

### æˆ‘ç”¨äº† C++20 çš„å‡½æ•°å‚æ•° auto è¯­æ³•ç³–

```cpp
int generic_sum(std::vector<int> const &v, auto op) {
}
```

è¿™é‡Œçš„å‚æ•° op ç±»å‹å£°æ˜ä¸º autoï¼Œæ•ˆæœå°±æ˜¯ï¼Œop è¿™ä¸ªå‚æ•°ç°åœ¨èƒ½æ¥å—ä»»æ„ç±»å‹çš„å¯¹è±¡äº†ï¼ˆåŒ…æ‹¬å‡½æ•°ï¼ï¼‰

```cpp
int generic_sum(std::vector<int> const &v, auto op) {
    ...
}
```

> {{ icon.detail }} å‡†ç¡®çš„è¯´ï¼Œ`auto op` å‚æ•°çš„æ•ˆæœæ˜¯ä½¿ `generic_sum` å˜ä¸ºä¸€ä¸ª**æ¨¡æ¿å‡½æ•°**ï¼Œå…¶ä¸­ op å‚æ•°å˜æˆäº†æ¨¡æ¿å‚æ•°ï¼Œèƒ½å¤Ÿæ¥å—ä»»æ„ç±»å‹äº†ã€‚è€Œå†™æ˜ç±»å‹çš„å‚æ•° `std::vector<int> const &v` å°±æ²¡æœ‰ä»»ä½•é¢å¤–æ•ˆæœï¼Œå°±åªèƒ½æ¥å— `vector<int>` è€Œå·²ã€‚

å¦‚æœä½ ä¸æ”¯æŒ C++20 çš„è¯ï¼Œéœ€è¦æ˜¾å¼å†™å‡º `template`ï¼Œæ‰èƒ½å®ç°åŒæ ·çš„æ•ˆæœï¼š

```cpp
template <typename Op>
int generic_sum(std::vector<int> const &v, Op op) {
    ...
}
```

> {{ icon.fun }} C++11ï¼šauto åªèƒ½ç”¨äºå®šä¹‰å˜é‡ï¼›C++14ï¼šå‡½æ•°è¿”å›ç±»å‹å¯ä»¥æ˜¯ autoï¼›C++17ï¼šæ¨¡æ¿å‚æ•°ä¹Ÿå¯ä»¥ autoï¼›C++20ï¼šå‡½æ•°å‚æ•°ä¹Ÿå¯ä»¥æ˜¯ auto äº†ï¼›ï¼ˆç‹‚æƒ³ï¼‰C++47ï¼šauto ç°åœ¨æ˜¯ C++47 çš„å”¯ä¸€å…³é”®å­—ï¼Œç”¨æˆ·åªéœ€ä¸æ–­è¾“å…¥ auto-auto-autoï¼Œç¼–è¯‘å™¨å†…å»ºäººå·¥æ™ºèƒ½è‡ªåŠ¨è¯†åˆ«ä½ çš„æ„å›¾ç”Ÿæˆæœºå™¨ç ã€‚

### å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼

åœ¨è¿‡å»çš„**é¢å‘å¯¹è±¡ç¼–ç¨‹èŒƒå¼*ä¸­ï¼Œå‡½æ•°ï¼ˆä»£ç ï¼‰å’Œå¯¹è±¡ï¼ˆæ•°æ®ï¼‰è¢«*å‰²è£‚*å¼€æ¥ï¼Œä»–ä»¬æ„šæ˜§åœ°è®¤ä¸º*å‡½æ•°ä¸æ˜¯å¯¹è±¡**ã€‚

**å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼*åˆ™è®¤ä¸ºï¼š*å‡½æ•°ä¹Ÿæ˜¯ä¸€ç§å˜é‡ï¼Œå‡½æ•°å¯ä»¥ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ï¼**

> {{ icon.fun }} Function lives matter!

> {{ icon.detail }} é¢å‘å¯¹è±¡å°±å¥½æ¯”è®¡ç®—æœºçš„â€œå“ˆä½›æ¶æ„â€ï¼Œä»£ç å’Œæ•°æ®å‰²è£‚ï¼Œä»£ç åªèƒ½å•æ–¹é¢æ“ä½œæ•°æ®ã€‚å‡½æ•°å¼å°±å¥½æ¯”â€œå†¯è¯ºä¾æ›¼æ¶æ„â€ï¼Œä»£ç ä¹Ÿæ˜¯æ•°æ®ã€‚çœ‹ä¼¼ä¼šå¯¼è‡´ä½æ•ˆï¼Œå®åˆ™å¤§å¤§æ–¹ä¾¿äº†åŠ¨æ€åŠ è½½æ–°ç¨‹åºï¼Œå› è€Œç°åœ¨çš„è®¡ç®—æœºåŸºæœ¬éƒ½é‡‡ç”¨äº†â€œå†¯è¯ºä¾æ›¼æ¶æ„â€ã€‚

æ€»ä¹‹ï¼Œå‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼Œè¢«äº²åˆ‡åœ°å°Šç§°ä¸º**å‡½æ•°å¯¹è±¡**ã€‚

### C++11 å¼•å…¥ Lambda è¯­æ³•ç³–

C++98 æ—¶ä»£ï¼Œäººä»¬è¿˜éœ€è¦å•ç‹¬è·‘åˆ° `main` å¤–é¢ï¼Œä¸“é—¨å®šä¹‰ `add`ã€`mul`ã€`max` å‡½æ•°ã€‚å¼„å¾—æ•´ä¸ªä»£ç ä¹±å“„å“„çš„ï¼Œéå¸¸éº»çƒ¦ã€‚

```cpp
int add(int a, int b) {
    return a + b;
}

int mul(int a, int b) {
    return a * b;
}

int max(int a, int b) {
    return std::max(a, b);
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};
    generic_sum(a, add);
    generic_sum(a, product);
    generic_sum(a, max);
    return 0;
}
```

C++11 å¼•å…¥äº† *Lambda è¡¨è¾¾å¼*è¯­æ³•ï¼Œå…è®¸ä½ å°±åœ°åˆ›å»ºä¸€ä¸ªå‡½æ•°ã€‚

```cpp
int main() {
    std::vector<int> a = {1, 2, 3, 4};

    auto add = [](int a, int b) {
        return a + b;
    };
    auto mul = [](int a, int b) {
        return a * b;
    };
    auto max = [](int a, int b) {
        return std::max(a, b);
    };

    generic_sum(a, add);
    generic_sum(a, product);
    generic_sum(a, max);
    return 0;
}
```

ä¸ç”¨å¾€ `main` å¤–é¢å¡åƒåœ¾äº†ï¼Œä¸€æ¸…çˆ½ã€‚

æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬ç”šè‡³ä¸ç”¨å®šä¹‰å˜é‡ï¼Œç›´æ¥æŠŠ Lambda è¡¨è¾¾å¼å†™åœ¨ `generic_sum` çš„å‚æ•°é‡Œå°±è¡Œäº†ï¼

```cpp
int main() {
    std::vector<int> a = {1, 2, 3, 4};

    generic_sum(a, [](int a, int b) {
        return a + b;
    });
    generic_sum(a, [](int a, int b) {
        return a * b;
    });
    generic_sum(a, [](int a, int b) {
        return std::max(a, b);
    }); // ***æ”¹***
    return 0;
}
```

> {{ icon.tip }} ä»¥ä¸Šå†™æ³•éƒ½æ˜¯ç­‰ä»·çš„ã€‚

è¦æ”¯æŒä¸€ä¸ªæ–°æ“ä½œï¼Œåªéœ€ä¿®æ”¹ä¸€å¤„åœ°æ–¹ï¼šåœ¨è°ƒç”¨ `generic_sum` æ—¶å°±åœ°åˆ›å»ºä¸€ä¸ªå‡½æ•°ã€‚éšå«éšåˆ°ï¼Œä¸ç”¨çº ç»“äºâ€œèµ·åå¼ºè¿«ç—‡â€ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿å‘¢ï¼Ÿ

> {{ icon.detail }} å‡†ç¡®çš„è¯´ï¼ŒLambda åˆ›å»ºçš„æ˜¯å‡½æ•°å¯¹è±¡ (function object) æˆ–ç§°ä»¿å‡½æ•° (functor) è€Œä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„å‡½æ•°ã€‚

> {{ icon.story }} å…¶å® C++98 æ—¶ä»£äººä»¬å°±å·²ç»å¤§é‡åœ¨ç”¨ `operator()()` æ¨¡æ‹Ÿå‡½æ•°å¯¹è±¡äº†ï¼Œè‘—åçš„ç¬¬ä¸‰æ–¹åº“ Boost ä¹Ÿå°è£…äº†å„ç§å‡½æ•°å¼å¸¸ç”¨çš„å®¹å™¨å’Œå·¥å…·ã€‚C++11 æ‰ç»ˆäºæŠŠ**å‡½æ•°å¯¹è±¡**è¿™ä¸ªæ¦‚å¿µè½¬æ­£ï¼Œå¹¶å¼•å…¥äº†æ›´æ–¹ä¾¿çš„ Lambda è¯­æ³•ç³–ã€‚

> {{ icon.fun }} å³ä½¿æ˜¯é¢å‘å¯¹è±¡çš„å¤´å·å­å­ Javaï¼Œä¹Ÿå·²ç»å¼€å§‹å¼•å…¥å‡½æ•°å¼çš„ Lambda è¯­æ³•ç³–ï¼ŒC\# çš„ LINQ æ›´æ˜¯æ˜ç›®å¼ èƒ†çš„è‡´æ•¬ map-reduce å…¨å®¶æ¡¶ï¼Œç”šè‡³ C è¯­è¨€ç”¨æˆ·ä¹Ÿå¼€å§‹ç©å„ç§å‡½æ•°æŒ‡é’ˆå›è°ƒâ€¦â€¦æ²¡åŠæ³•ï¼Œå‡½æ•°å¼ç¡®å®æ–¹ä¾¿å‘€ï¼

### ä¾èµ–æ³¨å…¥åŸåˆ™

å‡½æ•°å¯¹è±¡ `op` ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè®© `generic_sum` å†…éƒ¨å»è°ƒç”¨ï¼Œå°±åƒå¾€ `generic_sum` ä½“å†…â€œæ³¨å…¥â€äº†ä¸€æ®µè‡ªå®šä¹‰ä»£ç ä¸€æ ·ã€‚

è¿™å¯ä»¥è®© `generic_sum` åœ¨ä¸ä¿®æ”¹æœ¬ä½“çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¿®æ”¹â€œæ³¨å…¥â€éƒ¨åˆ†ï¼Œè½»æ¾æ‰©å±•ï¼Œæ»¡è¶³**å¼€é—­åŸåˆ™**ã€‚

æ›´å‡†ç¡®çš„è¯´ï¼Œè¿™ä½“ç°çš„æ˜¯è®¾è®¡æ¨¡å¼æ‰€è¦æ±‚çš„**ä¾èµ–æ³¨å…¥åŸåˆ™**ã€‚

* ä¾èµ–æ³¨å…¥åŸåˆ™: ä¸€ä¸ªå°è£…å¥½çš„å‡½æ•°æˆ–ç±»ï¼Œåº”è¯¥å°½é‡ä¾èµ–äºæŠ½è±¡æ¥å£ï¼Œè€Œä¸æ˜¯ä¾èµ–äºå…·ä½“å®ç°ã€‚è¿™å¯ä»¥æé«˜ç¨‹åºçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚

å››å¤§ç¼–ç¨‹èŒƒå¼éƒ½å„è‡ªå‘å±•å‡ºäº†**ä¾èµ–æ³¨å…¥åŸåˆ™**çš„è§£å†³æ–¹æ¡ˆï¼š

- é¢å‘è¿‡ç¨‹ç¼–ç¨‹èŒƒå¼ä¸­ï¼Œ**å‡½æ•°æŒ‡é’ˆ**å°±æ˜¯é‚£ä¸ªæŠ½è±¡æ¥å£ã€‚
- é¢å‘å¯¹è±¡ç¼–ç¨‹èŒƒå¼ä¸­ï¼Œ**è™šå‡½æ•°**å°±æ˜¯é‚£ä¸ªæŠ½è±¡æ¥å£ã€‚
- å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼ä¸­ï¼Œ**å‡½æ•°å¯¹è±¡**å°±æ˜¯é‚£ä¸ªæŠ½è±¡æ¥å£ã€‚
- æ¨¡æ¿å…ƒç¼–ç¨‹èŒƒå¼ä¸­ï¼Œ**æ¨¡æ¿å‚æ•°**å°±æ˜¯é‚£ä¸ªæŠ½è±¡æ¥å£ã€‚

åŒæ ·æ˜¯æŠŠæŠ½è±¡æ¥å£ä½œä¸ºå‚æ•°ï¼ŒåŒæ ·è§£å†³å¯æ‰©å±•é—®é¢˜ã€‚

å‡½æ•°æŒ‡é’ˆè´´è¿‘åº•å±‚ç¡¬ä»¶ï¼Œè™šå‡½æ•°æ–¹ä¾¿æ•´åˆå¤šä¸ªæ¥å£ï¼Œå‡½æ•°å¯¹è±¡è½»é‡çº§ã€éšåœ°å–ç”¨ï¼Œæ¨¡æ¿å…ƒæœ‰åŠ©é«˜æ€§èƒ½ä¼˜åŒ–ï¼Œä¸åŒçš„ç¼–ç¨‹èŒƒå¼æ®Šé€”åŒå½’ã€‚

### ä½è€¦åˆï¼Œé«˜å†…èš

ä¾èµ–æ³¨å…¥åŸåˆ™å¯ä»¥å‡å°‘ä»£ç ä¹‹é—´çš„è€¦åˆåº¦ï¼Œå¤§å¤§æé«˜ä»£ç çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚

* è€¦åˆåº¦: æŒ‡çš„æ˜¯ä¸€ä¸ªæ¨¡å—ã€ç±»ã€å‡½æ•°å’Œå…¶ä»–æ¨¡å—ã€ç±»ã€å‡½æ•°ä¹‹é—´çš„å…³è”ç¨‹åº¦ã€‚è€¦åˆåº¦è¶Šä½ï¼Œè¶Šå®¹æ˜“è¿›è¡Œå•å…ƒæµ‹è¯•ã€é‡æ„ã€å¤ç”¨å’Œæ‰©å±•ã€‚

> {{ icon.fun }} é«˜è€¦åˆåº¦çš„å…¸å‹æ˜¯â€œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«â€ã€‚ä½è€¦åˆçš„å…¸èŒƒæ˜¯èš¯èš“ï¼Œå› ä¸ºèš¯èš“å¯ä»¥åœ¨ä»»æ„æ–­é¢åˆ‡å¼€ï¼Œè¿˜èƒ½æ´»ä¸‹æ¥ï¼Œçœ‹æ¥èš¯èš“çš„èº«ä½“è®¾è®¡éå¸¸â€œæ¨¡å—åŒ–â€å‘¢ã€‚

é€šå¸¸æ¥è¯´ï¼Œè½¯ä»¶åº”å½“è¿½æ±‚ä½è€¦åˆåº¦ï¼Œé€‚åº¦è§£è€¦çš„è½¯ä»¶èƒ½æ›´å¿«é€‚åº”éœ€æ±‚å˜åŒ–ã€‚ä½†è¿‡åº¦çš„ä½è€¦åˆä¹Ÿä¼šå¯¼è‡´ä»£ç è¿‡äºåˆ†æ•£ï¼Œä¸æ˜“é˜…è¯»å’Œä¿®æ”¹ï¼Œç”šè‡³å¯èƒ½èµ·åˆ°åæ•ˆæœã€‚

> {{ icon.tip }} è‹¥ä½ è§£è€¦åï¼Œæ¯æ¬¡éœ€æ±‚å˜åŒ–è¦æ”¹åŠ¨çš„åœ°æ–¹å˜å°‘äº†ï¼Œé‚£å°±æ˜¯åˆç†çš„è§£è€¦ã€‚è‹¥ä½ è¿‡åˆ†è§£è€¦ï¼Œä»£ç ä¸œä¸€å—è¥¿ä¸€å—ï¼Œä»¥è‡³äºéœ€æ±‚å˜åŒ–æ—¶éœ€è¦åˆ°å¤„æ”¹ï¼Œæ¯”ä¸è§£è€¦æ—¶æµªè´¹çš„æ—¶é—´è¿˜è¦å¤šï¼Œé‚£å°±æ˜¯è§£è€¦è¿‡åº¦ã€‚

> {{ icon.fun }} å®Œå…¨é›¶è€¦åˆçš„ç¨‹åºæ¯ä¸ªå‡½æ•°äº’ä¸è”ç³»ï¼Œå°±åƒæŠŠèš¯èš“æ‹†æ•£æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„ç»†èƒä¸€æ ·ã€‚è¿åˆå§‹éœ€æ±‚â€œæ´»ç€â€éƒ½å®ç°ä¸äº†ï¼Œè°ˆä½•é€‚åº”éœ€æ±‚å˜åŒ–ï¼Ÿæ‰€ä»¥è§£è€¦ä¹Ÿåˆ‡å‹¿çŸ«æ‰è¿‡æ­£ã€‚

ä¸ºäº†é¿å…è§£è€¦çŸ«æ‰è¿‡æ­£ï¼Œäººä»¬åˆæå‡ºäº†å†…èšçš„æ¦‚å¿µï¼Œå¹¶è§„å®šè§£è€¦çš„å‰ææ˜¯ï¼šä¸è€½è¯¯å†…èšã€‚è€½è¯¯åˆ°å†…èšçš„è§£è€¦ï¼Œå°±åªä¼šèµ·åˆ°é™ä½å¯ç»´æŠ¤æ€§çš„åæ•ˆæœäº†ã€‚

* å†…èš: æŒ‡çš„æ˜¯åŒä¸€ä¸ªæ¨¡å—ã€ç±»ã€å‡½æ•°å†…éƒ¨å„ä¸ªå…ƒç´ ä¹‹é—´çš„å…³è”ç¨‹åº¦ã€‚å†…èšåº¦è¶Šé«˜ï¼ŒåŠŸèƒ½è¶Šç‹¬ç«‹ï¼Œè¶Šæ–¹ä¾¿é›†ä¸­ç»´æŠ¤ã€‚

> {{ icon.fun }} ä¾‹å¦‚ï¼Œäººçš„å¿ƒè„ä¸“é—¨è´Ÿè´£æ³µè¡€ï¼Œè‚è„åªè´Ÿè´£è§£æ¯’ï¼Œè¿™å°±æ˜¯é«˜å†…èšçš„äººä½“å™¨å®˜ã€‚è‹¥äººçš„å¿ƒè„è¿˜è¦å…¼èŒè§£æ¯’ï¼Œè‚è„è¿˜å…¼èŒæ³µè¡€ï¼Œçœ‹ä¼¼å¥½åƒæ˜¯å¢åŠ äº†â€œä¸‡ä¸€å¿ƒè„åæ‰â€çš„å†—ä½™æ€§ï¼Œå®é™…ä¸ŠæŠŠâ€œæ³µè¡€â€è¿™ä¸€åŠŸèƒ½æ‹†æ•£åˆ°å„åœ°ï¼Œæ— æ³•â€œé›†ä¸­åŠ›é‡æ³µå¤§è¡€â€äº†ã€‚

> {{ icon.detail }} äººç±»çš„å¤§è„‘å’Œ CPU ä¸€æ ·ï¼Œä¹Ÿæœ‰â€œç¼“å­˜å±€åŸŸæ€§ (cache-locality)â€çš„é™åˆ¶ï¼šä¸èƒ½åŒæ—¶åœ¨å¾ˆå¤šä¸ªä¸»é¢˜ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ï¼Œæ— è®ºæ˜¯æ—¶é—´ä¸Šçš„è¿˜æ˜¯ç©ºé—´ä¸Šçš„å‰²è£‚ (cache-miss)ï¼Œéƒ½ä¼šå¹²æ‰°ç¨‹åºå‘˜æ€ç»´çš„è¿è´¯æ€§ï¼Œä»è€Œå¢å¤§å¿ƒæ™ºè´Ÿæ‹…ã€‚

å¥½çš„è½¯ä»¶è¦ä¿æŒä½è€¦åˆï¼ŒåŒæ—¶é«˜å†…èšã€‚

> {{ icon.fun }} å°±åƒâ€œæ°‘ä¸»é›†ä¸­åˆ¶â€ä¸€æ ·ï¼Œæ—¢è¦ç›‘ç£é˜²æ­¢å¤§æƒç‹¬æ½ï¼Œåˆè¦é›†ä¸­åŠ›é‡åŠä¸€ä¸ªäººåŠä¸æˆçš„å¤§äº‹ã€‚

### ä¸ä¼ ç»Ÿé¢å‘å¯¹è±¡çš„å¯¹æ¯”

ä¼ ç»Ÿçš„é¢å‘å¯¹è±¡åŒæ ·å¯ä»¥ç”¨**è™šå‡½æ•°æ¥å£ç±»*æ¨¡æ‹Ÿ*å‡½æ•°å¯¹è±¡**ä¸€æ ·çš„åŠŸèƒ½ï¼Œåªä¸è¿‡æ²¡æœ‰ lambda å’Œé—­åŒ…çš„è¯­æ³•åŠ æŒï¼Œå†™èµ·æ¥éå¸¸ç¹çï¼Œå°±å’Œåœ¨ C è¯­è¨€é‡Œâ€œæ¨¡æ‹Ÿâ€é¢å‘å¯¹è±¡ä¸€æ ·ã€‚

> {{ icon.fun }} ä¸ºäº†è¿™ä¹ˆå°çš„ä¸€ä¸ªä»£ç å—ï¼Œå•ç‹¬å®šä¹‰ä¸€ä¸ªç±»ï¼Œå°±åƒå¦ˆå¦ˆå¼€ä¸€æ¶â€œç©ºä¸­æˆ˜è½¦â€ A380 åªæ˜¯ä¸ºäº†æ¥ä½ æ”¾å­¦ä¸€æ ·ï¼Œç­‰ä½ å€¼å¥½æœºçš„æ—¶é—´æˆ‘è‡ªå·±èµ°éƒ½èµ°åˆ°äº†ã€‚è€Œå‡½æ•°å¼ä¸­ï¼Œç”¨ lambda å°±åœ°å®šä¹‰å‡½æ•°å¯¹è±¡ï¼Œç›¸å½“äºéšåœ°æŠ“æ¥ä¸€å°å…±äº«å•è½¦å¼€èµ°ã€‚

```cpp
struct OpBase { // é¢å‘å¯¹è±¡ï¼šé‡äº‹ä¸å†³å…ˆå®šä¹‰æ¥å£â€¦â€¦
    virtual int compute(int a, int b) = 0;
    virtual ~OpBase() = default;
};

struct OpAdd : OpBase {
    int compute(int a, int b) override {
        return a + b;
    }
};

struct OpMul : OpBase {
    int compute(int a, int b) override {
        return a * b;
    }
};

struct OpMax : OpBase {
    int compute(int a, int b) override {
        return std::max(a, b);
    }
};

int generic_sum(std::vector<int> const &v, OpBase *op) {
    int ret = v[0];
    for (int i = 1; i < v.size(); ++i) {
        ret = op->compute(ret, v[i]); // å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œéœ€è¦è°ƒç”¨ä»–çš„æˆå‘˜å‡½æ•°ï¼Œæˆå‘˜å‡½æ•°åˆè¦èµ·åâ€¦â€¦
    }
    delete op;
    return ret;
}

int main() {
    std::vector<int> a = {1, 2, 3, 4};

    generic_sum(a, new OpAdd());
    generic_sum(a, new OpMul());
    generic_sum(a, new OpMax());
    return 0;
}
```

ä¸ä»…éœ€è¦å®šä¹‰ä¸€å †ç±»ï¼Œæ¥å£ç±»ï¼Œå®ç°ç±»ï¼Œç»§æ‰¿æ¥ç»§æ‰¿å»ï¼Œè¿˜éœ€è¦ç®¡ç†è®¨åŒçš„æŒ‡é’ˆï¼Œä»£ç é‡ç¿»å€ï¼Œæ²¡ä»€ä¹ˆå¯è¯»æ€§ï¼Œåˆå½±å“è¿è¡Œæ•ˆç‡ã€‚

> {{ icon.fun }} 3 å¹´ 2 ç­å°å½­åŒå­¦ï¼Œä½ çš„å¦ˆå¦ˆå¼€ç€ A380 æ¥æ¥ä½ äº†ã€‚

è€Œç°ä»£ C++ åªéœ€ Lambda è¯­æ³•å°±åœ°å®šä¹‰å‡½æ•°å¯¹è±¡ï¼Œçˆ½ã€‚

```cpp
    generic_sum(a, [](int a, int b) {
        return a + b;
    });
    generic_sum(a, [](int a, int b) {
        return a * b;
    });
    generic_sum(a, [](int a, int b) {
        return std::max(a, b);
    });
```

### å‡½æ•°å¯¹è±¡åœ¨æ¨¡æ¿åŠ æŒä¸‹é™æ€åˆ†å‘

åˆšåˆšï¼Œæˆ‘ä»¬çš„å®ç°ç”¨äº† `auto op` åšå‚æ•°ï¼Œè¿™ç­‰ä»·äºè®© `generic_sum` å˜æˆä¸€ä¸ªæ¨¡æ¿å‡½æ•°ã€‚

```cpp
int generic_sum(std::vector<int> const &v, auto op);

// ä¸æ”¯æŒ C++20 æ—¶çš„æ›¿ä»£å†™æ³•ï¼š
template <typename Op>
int generic_sum(std::vector<int> const &v, Op op);
```

è¿™æ„å‘³ç€æ¯å½“ç”¨æˆ·æŒ‡å®šä¸€ä¸ªæ–°çš„å‡½æ•°å¯¹è±¡ï¼ˆlambdaï¼‰æ—¶ï¼Œ`generic_sum` éƒ½ä¼šé‡æ–°å®ä¾‹åŒ–ä¸€éã€‚

```cpp
    generic_sum(a, [](int a, int b) {
        return a + b;
    });
    generic_sum(a, [](int a, int b) {
        return a * b;
    });
    generic_sum(a, [](int a, int b) {
        return std::max(a, b);
    });
```

ç¼–è¯‘åï¼Œä¼šå˜æˆç±»ä¼¼äºè¿™æ ·ï¼š

```cpp
    generic_sum<add>(a);
    generic_sum<mul>(a);
    generic_sum<max>(a);
```

ä¼šç”Ÿæˆä¸‰ä»½å‡½æ•°ï¼Œæ¯ä¸ªéƒ½æ˜¯ç‹¬ç«‹ç¼–è¯‘çš„ï¼š

```cpp
int generic_sum<add>(std::vector<int> const &v) {
    int ret = v[0];
    for (int i = 1; i < v.size(); ++i) {
        ret = add(ret, v[i]);
    }
    return ret;
}
int generic_sum<mul>(std::vector<int> const &v) {
    int ret = v[0];
    for (int i = 1; i < v.size(); ++i) {
        ret = mul(ret, v[i]);
    }
    return ret;
}
int generic_sum<max>(std::vector<int> const &v) {
    int ret = v[0];
    for (int i = 1; i < v.size(); ++i) {
        ret = max(ret, v[i]);
    }
    return ret;
}
```

è¿™å…è®¸ç¼–è¯‘å™¨ä¸ºæ¯ä¸ªç‰ˆæœ¬çš„ `generic_sum` å•ç‹¬åšä¼˜åŒ–ï¼Œé‡èº«å®šåˆ¶æœ€ä¼˜çš„ä»£ç ã€‚

ä¾‹å¦‚ `add` è¿™ä¸ªå‡½æ•°å¯¹è±¡ï¼Œå› ä¸ºåªåœ¨ `generic_sum<add>` ä¸­ä½¿ç”¨äº†ï¼Œä¼šè¢«è¢«ç¼–è¯‘å™¨è‡ªåŠ¨å†…è”ï¼Œä¸ä¼šäº§ç”Ÿå‡½æ•°è°ƒç”¨å’Œè·³è½¬çš„æŒ‡ä»¤ï¼Œå„è‡ªä¼˜åŒ–æˆå•ç‹¬ä¸€æ¡åŠ æ³• / ä¹˜æ³• / æœ€å¤§å€¼æŒ‡ä»¤ç­‰ã€‚

> {{ icon.detail }} æ¯”å¦‚ï¼Œç¼–è¯‘å™¨ä¼šæ£€æµ‹åˆ° `+=` å¯ä»¥çŸ¢é‡åŒ–ï¼Œäºæ˜¯ç”¨ `_mm_add_epi32` æ›¿ä»£äº†ã€‚åŒç†ï¼Œmul åˆ™ç”¨ `_mm_mullo_epi32` æ›¿ä»£ï¼Œmax åˆ™ç”¨ `_mm_max_epi32` æ›¿ä»£ç­‰ï¼Œå„è‡ªåˆ†åˆ«ç”Ÿæˆäº†å„è‡ªç‰ˆæœ¬æœ€ä¼˜çš„ä»£ç ã€‚è€Œå¦‚æœæ˜¯æ™®é€šçš„å‡½æ•°æŒ‡é’ˆï¼Œä¸ä¼šç”Ÿæˆä¸‰ä»½é‡èº«å®šåšçš„å®ä¾‹ï¼Œæ— æ³•çŸ¢é‡åŒ–ï¼ˆæœ‰ä¸€ç§ä¾‹å¤–ï¼Œå°±æ˜¯ç¼–è¯‘å™¨æ£€æµ‹åˆ°äº† `generic_sum` ä¼¼ä¹åªæœ‰è¿™ä¸‰ç§å¯èƒ½å‚æ•°ï¼Œç„¶ååšäº† IPO ä¼˜åŒ–ï¼Œä½†å¹¶ä¸å¦‚æ¨¡æ¿å®ä¾‹åŒ–ä¸€æ ·ç¨³å®šå¼ºåˆ¶ï¼‰ã€‚

ä¸ºä¸‰ç§ä¸åŒçš„ op å‚æ•°åˆ†åˆ«å®šåšä¸‰ä»½ã€‚è™½ç„¶å¢åŠ äº†ç¼–è¯‘æ—¶é—´ï¼Œè†¨èƒ€äº†ç”Ÿæˆçš„äºŒè¿›åˆ¶ä½“ç§¯ï¼›ä½†ç”Ÿæˆçš„æœºå™¨ç æ˜¯åˆ†åˆ«é’ˆå¯¹æ¯ç§ç‰¹ä¾‹ä¸€å¯¹ä¸€æ·±åº¦ä¼˜åŒ–çš„ï¼Œæ›´é«˜æ•ˆã€‚

> {{ icon.story }} ä¾‹å¦‚çŸ©é˜µä¹˜æ³•ï¼ˆgemmï¼‰çš„æœ€ä¼˜ç®—æ³•ï¼Œå¯¹äºä¸åŒçš„çŸ©é˜µå¤§å°å’Œå½¢çŠ¶æ˜¯ä¸åŒçš„ã€‚è‘—åçš„çº¿æ€§ä»£æ•°åº“ CUBLAS å’Œ MKL ä¸­ï¼Œä¼šè‡ªåŠ¨æ ¹æ®ç”¨æˆ·è¾“å…¥çš„çŸ©é˜µå½¢çŠ¶ï¼Œé€‰å–æœ€ä¼˜çš„ç®—æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCUBLAS åº“é‡Œå…¶å®å­˜ç€é€‚åˆå„ç§çŸ©é˜µå¤§å°æ’åˆ—ç»„åˆçš„ç®—æ³•ä»£ç ï¼ˆä»¥ fatbin æ ¼å¼å­˜å‚¨åœ¨äºŒè¿›åˆ¶ä¸­ï¼‰ã€‚å½“è°ƒç”¨çŸ©é˜µä¹˜æ³•æ—¶ï¼Œè‡ªåŠ¨æŸ¥åˆ°æœ€é€‚åˆçš„ä¸€ç‰ˆæ¥è°ƒç”¨ç»™ä½ ã€‚ç±»ä¼¼ gemmï¼Œè¿˜æœ‰ gemvã€spmvâ€¦â€¦æ‰€æœ‰çš„çŸ©é˜µè¿ç®— API éƒ½ç»å†äº†è¿™æ ·çš„â€œç¼–è¯‘æœŸâ€æš´åŠ›æ’åˆ—ç»„åˆï¼Œåªä¸ºâ€œè¿è¡Œæ—¶â€é‡Šæ”¾æœ€å¤§æ€§èƒ½ï¼è¿™ä¹Ÿå¯¼è‡´ç¼–è¯‘å¥½çš„ cublas.dll æ–‡ä»¶æ¥åˆ°äº†ææ€–çš„ 20 MB å·¦å³ï¼Œè€Œæˆ‘ä»¬ç§°ä¹‹ä¸ºé«˜æ•ˆã€‚

### å‡½æ•°å¯¹è±¡ä¹Ÿå¯åœ¨ function å®¹å™¨ä¸­åŠ¨æ€åˆ†å‘

Lambda å‡½æ•°å¯¹è±¡çš„ç±»å‹æ˜¯åŒ¿åçš„ï¼Œæ¯ä¸ª Lambda è¡¨è¾¾å¼éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å‡½æ•°å¯¹è±¡ç±»å‹ï¼Œè¿™ä½¿å¾— `generic_sum` å¯¹äºæ¯ä¸ªä¸åŒçš„ Lambda éƒ½ä¼šå®ä¾‹åŒ–ä¸€éã€‚è™½ç„¶æœ‰åˆ©äºæ€§èƒ½ä¼˜åŒ–ï¼Œä½†ä¹Ÿå½±å“äº†ç¼–è¯‘é€Ÿåº¦å’Œçµæ´»æ€§ã€‚

> {{ icon.detail }} é€šå¸¸ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ `decltype(add)` è·å– `add` è¿™ä¸ª Lambda å¯¹è±¡çš„ç±»å‹ã€‚ä¹Ÿåªèƒ½é€šè¿‡ `auto` æ¥æ•è· Lambda å¯¹è±¡ä¸ºå˜é‡ã€‚

ä¸ºæ­¤ï¼Œæ ‡å‡†åº“æä¾›äº† `std::function` å®¹å™¨ï¼Œä»–èƒ½å®¹çº³ä»»ä½•å‡½æ•°å¯¹è±¡ï¼æ— è®ºæ˜¯åŒ¿åçš„ Lambda å‡½æ•°å¯¹è±¡ï¼Œè¿˜æ˜¯æ™®æ™®é€šé€šçš„å‡½æ•°æŒ‡é’ˆï¼Œéƒ½èƒ½çº³å…¥ `std::function` çš„ä½“å†…ã€‚

å”¯ä¸€çš„ä»£ä»·æ˜¯ï¼Œä½ éœ€è¦æŒ‡å®šå‡ºæ‰€æœ‰å‚æ•°çš„ç±»å‹ï¼Œå’Œè¿”å›å€¼çš„ç±»å‹ã€‚

ä¾‹å¦‚å‚æ•°ä¸ºä¸¤ä¸ª `int`ï¼Œè¿”å› `int` çš„å‡½æ•°ï¼Œå¯ä»¥ç”¨ `std::function<int(int, int)>` å®¹å™¨å­˜å‚¨ã€‚

```cpp
auto add_lambda = [](int a, int b) { // Lambda å‡½æ•°å¯¹è±¡
    return a + b;
};

struct AddClass {
    int operator()(int a, int b) {   // è‡ªå®šä¹‰ç±»æ¨¡æ‹Ÿå‡½æ•°å¯¹è±¡
        return a + b;
    }
};
AddClass add_object;

int add_regular_func(int a, int b) { // æ™®é€šå‡½æ•°
    return a + b;
}

std::function<int(int, int)> add; // æ‰€æœ‰å¹¿ä¹‰å‡½æ•°å¯¹è±¡ï¼Œç»Ÿç»Ÿæ¥çº³
add = add_lambda;           // OK
add = add_object;           // OK
add = add_regular_func;     // OK
```

```cpp
int generic_sum(std::vector<int> const &v,
                std::function<int(int, int)> op) {
    int ret = v[0];
    for (int i = 1; i < v.size(); ++i) {
        ret = op(ret, v[i]); // å†™èµ·æ¥å’Œæ¨¡æ¿ä¼ å‚æ—¶ä¸€æ ·æ— æ„Ÿ
    }
    // æ— éœ€æŒ‡é’ˆï¼Œæ— éœ€ deleteï¼Œfunction èƒ½è‡ªåŠ¨ç®¡ç†å‡½æ•°å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
    return ret;
}
```

> {{ icon.detail }} å¦‚æœè¿˜æƒ³æ”¯æŒä»»æ„ç±»å‹çš„å‚æ•°å’Œè¿”å›å€¼ï¼Œé‚£ä¹ˆä½ å¯ä»¥è¯•è¯•çœ‹ `std::function<std::any(std::any)>`ã€‚è¿™é‡Œ `std::any` æ˜¯ä¸ªè¶…çº§ä¸‡èƒ½å®¹å™¨ï¼Œå¯ä»¥å®¹çº³ä»»ä½•å¯¹è±¡ï¼Œä»–å’Œ `std::function` ä¸€æ ·éƒ½é‡‡ç”¨äº†â€œç±»å‹æ“¦é™¤ (type-erasure)â€æŠ€æœ¯ï¼Œç¼ºç‚¹æ˜¯å¿…é¡»é…åˆ `std::any_cast` æ‰èƒ½å–å‡ºä½¿ç”¨ï¼Œä¹‹åçš„æ¨¡æ¿å…ƒè¿›é˜¶ä¸“é¢˜ä¸­ä¼šè¯¦ç»†ä»‹ç»ä»–ä»¬çš„åŸç†ï¼Œå¹¶å¸¦ä½ è‡ªå·±åšä¸€ä¸ªæ“¦åŠ æ³•çš„ç±»å‹æ“¦é™¤å®¹å™¨ã€‚

å‡½æ•°å¼ç¼–ç¨‹ï¼Œèƒ½åœ¨é™æ€ä¸åŠ¨æ€ä¹‹é—´è½»æ¾åˆ‡æ¢ï¼Œ**é«˜æ€§èƒ½*ä¸*çµæ´»æ€§**ä»»å›é€‰æ‹©ã€‚

- åœ¨éœ€è¦æ€§èƒ½çš„**ç“¶é¢ˆä»£ç **ä¸­ç”¨æ¨¡æ¿ä¼ å‚ï¼Œç¼–è¯‘æœŸé™æ€åˆ†å‘ï¼Œå¤šæ¬¡é‡èº«å®šåšï¼Œæé«˜è¿è¡Œæ—¶æ€§èƒ½ã€‚

* ç“¶é¢ˆä»£ç : å¾€å¾€ä¸€ä¸ªç¨‹åº 80% çš„æ—¶é—´èŠ±åœ¨ 20% çš„ä»£ç ä¸Šã€‚è¿™ 20% æ˜¯åœ¨ç¨‹åºä¸­é¢‘ç¹æ‰§è¡Œçš„ã€è®¡ç®—é‡å¤§çš„ã€æˆ–è€…è°ƒç”¨ç‰¹åˆ«è€—æ—¶çš„å‡½æ•°ã€‚é’ˆå¯¹è¿™éƒ¨åˆ†ç“¶é¢ˆä»£ç ä¼˜åŒ–å³å¯ï¼Œè€Œå‰©ä½™çš„ 80% æ‰“é…±æ²¹ä»£ç ï¼Œå¤§å¯ä»¥æ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆå†™ã€‚

- åœ¨æ€§èƒ½æ— å…³ç´§è¦çš„é¡¶å±‚ä¸šåŠ¡é€»è¾‘ä¸­ç”¨ function å®¹å™¨ä¼ å‚ï¼Œè¿è¡Œæ—¶åŠ¨æ€åˆ†å‘ï¼ŒèŠ‚çœç¼–è¯‘ä½“ç§¯ï¼Œæ–¹ä¾¿æŒä¹…å­˜å‚¨ï¼Œçµæ´»æ˜“ç”¨ã€‚

> {{ icon.tip }} ä¾‹å¦‚ä¸Šé¢çš„ `generic_sum` å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬çªç„¶æƒ³è¦é«˜æ€§èƒ½äº†ï¼Œåªéœ€æŠŠ `std::function<int(int, int)> op` è½»è½»æ”¹ä¸º `auto op` å°±è½»æ¾åˆ‡æ¢åˆ°é™æ€åˆ†å‘æ¨¡å¼äº†ã€‚

è€Œè™šå‡½æ•°ä¸€æ—¦ç”¨äº†ï¼ŒåŸºæœ¬å°±åªèƒ½åŠ¨æ€åˆ†å‘äº†ï¼Œå³ä½¿èƒ½è¢« IPO ä¼˜åŒ–æ‰ï¼Œè™šè¡¨æŒ‡é’ˆä¹Ÿæ°¸è¿œå æ®ç€ä¸€ä¸ª 8 å­—èŠ‚çš„ç©ºé—´ï¼Œä¸”æ°¸è¿œåªèƒ½ä»¥æŒ‡é’ˆå½¢å¼ä¼ æ¥ä¼ å»ã€‚

> {{ icon.detail }} ä¸€ç§é™æ€åˆ†å‘ç‰ˆçš„è™šå‡½æ•°æ›¿ä»£å“æ˜¯ CRTPï¼Œä»–åŸºäºæ¨¡æ¿å…ƒç¼–ç¨‹ï¼Œä½†ä¸è™šå‡½æ•°ä¹‹é—´åˆ‡æ¢å›°éš¾ï¼Œä¸åƒå‡½æ•°å¯¹è±¡é‚£ä¹ˆæ— æ„Ÿï¼Œä¹‹åçš„æ¨¡æ¿å…ƒä¸“é¢˜è¯¾ä¸­ä¼šä¸“é—¨ä»‹ç»ã€‚

### æ¡ˆä¾‹ï¼šå‡½æ•°å¯¹è±¡çš„åŠ¨æ€åˆ†å‘ç”¨äºå¤šçº¿ç¨‹ä»»åŠ¡é˜Ÿåˆ—

ä¸»çº¿ç¨‹ä¸æ–­åœ°å‘å·¥ä½œè€…çº¿ç¨‹å‘é€å‡½æ•°å¯¹è±¡ï¼Œä»¤å…¶ä»£ä¸ºæ‰§è¡Œï¼š

```cpp
mt_queue<std::function<void()>> task_queue;

void main_thread() {
    task_queue.push([] {
        fmt::println("æ­£åœ¨æ‰§è¡Œä»»åŠ¡1");
    });
    task_queue.push([] {
        fmt::println("æ­£åœ¨æ‰§è¡Œä»»åŠ¡2");
    });
}

void worker_thread() {
    while (true) {
        auto task = task_queue.pop();
        task();
    }
}
```

> {{ icon.detail }} `mt_queue` æ˜¯å°å½­è€å¸ˆå°è£…çš„å¤šçº¿ç¨‹å®‰å…¨çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°åŸç†ä¼šåœ¨ç¨åçš„å¤šçº¿ç¨‹ä¸“é¢˜è¯¾ä¸­è¯¦ç»†è®²è§£ã€‚

### å‡½æ•°å¯¹è±¡çš„é‡è¦æœºåˆ¶ï¼šé—­åŒ…

é—­åŒ…æ˜¯å‡½æ•°å¯¹è±¡çš„é‡è¦æœºåˆ¶ï¼Œä»–å…è®¸å‡½æ•°å¯¹è±¡æ•è·å¤–éƒ¨å˜é‡ï¼Œå¹¶åœ¨å‡½æ•°å¯¹è±¡å†…éƒ¨ä½¿ç”¨è¿™äº›å˜é‡ã€‚

```cpp
int x = 10;
auto add_x = [x](int a) {
    return a + x;
};
fmt::println("{}", add_x(5)); // è¾“å‡º 15
```

> {{ icon.tip }} é—­åŒ…æ•è·çš„å˜é‡é»˜è®¤æ˜¯åªè¯»çš„ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹æ•è·çš„å˜é‡ï¼Œå¯ä»¥åŠ ä¸Š `mutable` ä¿®é¥°ï¼Œè§åæ–‡ã€‚

#### é—­åŒ…çš„æœ¬è´¨æ˜¯è¯­æ³•ç³–

Lambda å‡½æ•°å¯¹è±¡çš„é—­åŒ…è¯­æ³•ï¼š

```cpp
int x = 10;
auto add_x = [x](int a) {
    return a + x;
};
```

å®é™…ä¸Šç­‰ä»·äºä¸€ä¸ªå¸¦æœ‰ `operator()` æˆå‘˜å‡½æ•°çš„ç»“æ„ä½“ï¼š

```cpp
struct Lambda {
    int x;
    Lambda(int val) : x(val) {}

    int operator() (int a) const {
        return a + x;
    }
};

int main() {
    int x = 10;
    Lambda add_x(x);
    fmt::println("{}", add_x(5)); // è¾“å‡º 15
    return 0;
}
```

> {{ icon.tip }} ç›¸å½“äºæˆ‘ä»¬å†™çš„ lambda å‡½æ•°ä½“ï¼Œå®é™…ä¸Šè¢«ç¼–è¯‘å™¨ç§»åˆ°äº† `Lambda` ç±»çš„ `operator()` æˆå‘˜å‡½æ•°ä½“å†…ã€‚

è€Œä¸”è¿™ç»“æ„ä½“æ˜¯åŒ¿åçš„ï¼Œæ²¡æœ‰ç¡®å®šçš„åå­—ï¼Œæ­¤å¤„ç±»å `Lambda` åªæ˜¯ç¤ºæ„ï¼Œå› è€Œå¹³æ—¶åªèƒ½é€šè¿‡ `auto` ä¿å­˜å³æ—¶åˆ›å»ºçš„ lambda å¯¹è±¡ã€‚

**è€Œæ‰€è°“çš„é—­åŒ…æ•è·å˜é‡ï¼Œå®é™…ä¸Šå°±æ˜¯è¿™ä¸ªç»“æ„ä½“çš„æˆå‘˜ï¼**

æŒ‰å€¼æ•è·ï¼Œå°±ç›¸å½“äºç»“æ„ä½“æˆå‘˜é‡Œæ‹·è´äº†ä¸€ä»½åŒåçš„æˆå‘˜ï¼›å¦‚æœæ˜¯å¼•ç”¨æ•è·ï¼Œå°±ç›¸å½“äºç»“æ„ä½“é‡Œçš„æˆå‘˜æ˜¯ä¸ªå¼•ç”¨ã€‚

> {{ icon.tip }} å¯ä»¥åœ¨ https://cppinsights.io è¿™ä¸ªç½‘ç«™ï¼Œè‡ªåŠ¨æ‹†è§£åŒ…æ‹¬ Lambda åœ¨å†…çš„æ‰€æœ‰ç°ä»£ C++ è¯­æ³•ç³–ä¸ºåŸå§‹çš„ç»“æ„ä½“å’Œå‡½æ•°ã€‚æ›´å¤šå¥½ç”¨çš„å·¥å…·ç½‘ç«™å¯ä»¥çœ‹æˆ‘ä»¬ [å·¥å…·å’Œé¡¹ç›®æ¨è](recommend.md) ä¸“é¢˜ç« èŠ‚ã€‚

å¯¹äºå¼•ç”¨ï¼Œåˆ™æ˜¯ç­‰ä»·äºç»“æ„ä½“æˆå‘˜ä¸­å«æœ‰ä¸€ä»½å¼•ç”¨ä½œä¸ºæˆå‘˜ï¼š

```cpp
int x = 10;
auto inc_x = [&x](int a) {
    return x++;
};
```

```cpp
struct Lambda {
    int &x;
    Lambda(int &val) : x(val) {}

    int operator() () const {
        return x++;
    }
};

int main() {
    int x = 10;
    Lambda inc_x(x);
    fmt::println("{}", inc_x()); // è¾“å‡º 10
    fmt::println("{}", inc_x()); // è¾“å‡º 11
    fmt::println("{}", inc_x()); // è¾“å‡º 12
    fmt::println("{}", x);       // è¾“å‡º 13
    return 0;
}
```

#### `operator()` å¾ˆæœ‰è¿·æƒ‘æ€§

åŒ¿å lambda å¯¹è±¡ï¼š

```cpp
auto lambda = [] (int a) {
    return a + 1;
};
int ret = lambda(2);
```

ç­‰ä»·äºä»¥ä¸‹çš„ç±»ï¼š

```cpp
struct Lambda {
    int operator() (int a) const {
        return a + 1;
    }
};
Lambda lambda;
int ret = lambda(2);
```

å¾ˆå¤šåŒå­¦éƒ½åˆ†ä¸æ¸… `operator` `operator()` `opeartor()()`ï¼Œè¿™ä¸ªæ‹¬å·ç¡®å®å¾ˆæœ‰è¿·æƒ‘æ€§ï¼Œä»Šå¤©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ã€‚

ä½ ç°åœ¨ï¼ŒæŠŠä¸Šé¢è¿™æ®µä»£ç ï¼Œæ”¹æˆè¿™æ ·ï¼š

```cpp
struct Lambda {
    int call (int a) const {
        return a + 1;
    }
};
Lambda lambda;
int ret = lambda.call(2);
```

æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“çœ‹æ‡‚ï¼Ÿè¿™å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªæˆå‘˜å‡½æ•° `call`ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªæˆå‘˜å‡½æ•°ã€‚

ç°åœ¨ï¼Œè¿›ä¸€æ­¥æ”¹æˆï¼š

```cpp
struct Lambda {
    int operator_call (int a) const {
        return a + 1;
    }
};
Lambda lambda;
int ret = lambda.operator_call(2);
```

èƒ½ä¸èƒ½ç†è§£ï¼Ÿè¿™å°±æ˜¯æŠŠå‡½æ•°åæ”¹æˆäº† `operator_call`ï¼Œä¾ç„¶æ˜¯ä¸€ä¸ªæˆå‘˜å‡½æ•°ã€‚

é‡ç‚¹æ¥äº†ï¼Œæˆ‘ä»¬æŠŠå‡½æ•°åï¼Œæ³¨æ„æ˜¯å‡½æ•°åå« `operator()`ï¼Œè¿™ä¸ªç©ºçš„åœ†æ‹¬å·æ˜¯å‡½æ•°åçš„ä¸€éƒ¨åˆ†ï¼

```cpp
struct Lambda {
    int operator() (int a) const {
        return a + 1;
    }
};
Lambda lambda;
int ret = lambda.operator() (2);
```

èƒ½ä¸èƒ½ç†è§£ï¼Ÿ`operator` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å…³é”®å­—ï¼Œæ•ˆæœæ˜¯å’Œåé¢çš„ä¸€ä¸ªè¿ç®—ç¬¦ç»“åˆï¼Œå½¢æˆä¸€ä¸ªç‰¹æ®Šçš„â€œæ ‡è¯†ç¬¦â€ï¼Œè¿™ä¸ªâ€œæ ‡è¯†ç¬¦â€å’Œæ™®é€šå‡½æ•°åä¸€æ ·ï¼Œéƒ½æ˜¯â€œå•ä¸ªå•è¯â€ï¼Œä¸å¯åˆ†å‰²ã€‚

ä¾‹å¦‚ `operator+` å°±æ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œ`operator[]` ä¹Ÿæ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬è¿™é‡Œçš„ `operator()` ä¹Ÿæ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œæ²¡æœ‰ä»€ä¹ˆç¨€å¥‡çš„ï¼Œåªä¸è¿‡åé¢è¿çš„è¿ç®—ç¬¦åˆšå¥½æ˜¯æ‹¬å·è€Œå·²ã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `lambda . operator()` æ¥è®¿é—®è¿™ä¸ªæˆå‘˜ï¼Œå°±å¯ä»¥çœ‹å‡ºï¼Œ`operator()` å°±å’Œä¸€ä¸ªæ™®é€šæˆå‘˜åå­—ä¸€æ ·ï¼Œæ²¡æœ‰åŒºåˆ«ï¼Œä¸€æ ·å¯ä»¥é€šè¿‡ `.` è®¿é—®ã€‚

ä¾‹å¦‚ï¼Œå¯¹äºè¿ç®—ç¬¦ `+` æ¥è¯´ï¼Œå½“ç¼–è¯‘å™¨æ£€æµ‹åˆ° `lambda + 2` è¿™æ ·çš„è¡¨è¾¾å¼æ—¶ï¼Œä¼šè‡ªåŠ¨ç¿»è¯‘æˆ `lambda.operator+ (2)`ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„è¿ç®—ç¬¦é‡è½½ã€‚

```cpp
struct Lambda {
    int operator+ (int a) const {
        return a + 1;
    }
};
Lambda lambda;
int ret = lambda + 2;
// ä¼šè¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆï¼š
int ret = lambda.operator+ (2);
```

åŒæ ·çš„ï¼Œå¯¹äº `()` è¿ç®—ç¬¦ï¼Œä¹Ÿä¼šè¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆ `operator()` è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨ï¼Œç”±äºå¯¹ `operator()` å‡½æ•°æœ¬èº«çš„è°ƒç”¨ä¹Ÿéœ€è¦ä¸€ä¸ªæ‹¬å·ï¼ˆå‚æ•°åˆ—è¡¨ï¼‰ï¼Œæ‰€ä»¥çœ‹èµ·æ¥å°±æœ‰ä¸¤ä¸ªæ‹¬å·äº†ã€‚å®é™…ä¸Šæ ¹æœ¬ä¸æ­ç•Œï¼Œä¸€ä¸ªæ˜¯å‡½æ•°åæ ‡è¯†ç¬¦çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯äº§ç”Ÿå‡½æ•°è°ƒç”¨ã€‚

```cpp
struct Lambda {
    int operator() (int a) const {
        return a + 1;
    }
};
Lambda lambda;
int ret = lambda(2);
// ä¼šè¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆï¼š
int ret = lambda.operator() (2);
```

è¿™æ—¶å€™ï¼Œå»æ‰ `(2)` é‡Œçš„å‚æ•° `2`ï¼Œå°±å˜æˆäº†è®©ä½ å¾ˆå›°æƒ‘çš„åŒæ‹¬å·ã€‚è€Œå¾ˆå¤šäººå–œæ¬¢ç´§æŒ¨è€…è¿å†™ï¼Œçœ‹èµ·æ¥å°±å¾ˆè¿·æƒ‘ã€‚

å®é™…ä¸Šï¼Œç¬¬ä¸€ä¸ª `()` æ˜¯å‡½æ•°åå­—çš„ä¸€éƒ¨åˆ†ï¼Œå’Œ `operator` æ˜¯è¿åœ¨ä¸€èµ·çš„ï¼Œä¸å¯åˆ†å‰²ï¼Œä¸­é—´ä¹Ÿä¸èƒ½æœ‰å…¶ä»–å‚æ•°ã€‚ç¬¬äºŒä¸ª `()` æ˜¯å‡½æ•°å‚æ•°åˆ—è¡¨ï¼Œåªä¸è¿‡è¿™é‡Œåˆšå¥½æ˜¯æ²¡æœ‰å‚æ•°ï¼Œæ‰€ä»¥çœ‹èµ·æ¥ä¹Ÿæ˜¯ä¸ªç©ºæ‹¬å·ï¼Œå¾ˆå¤šåˆå­¦è€…çœ‹åˆ°å°±è¿·ç³Šäº†ï¼Œè¿˜çœ‹ä¸æ‡‚å»ºè®®ä»ä¸Šé¢æœ‰ä¸€ä¸ªå‚æ•°çš„ `operator() (int a)` çœ‹ã€‚

```cpp
struct Lambda {
    int operator() () const {
        return 1;
    }
};
Lambda lambda;
int ret = lambda();
// ä¼šè¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆï¼š
int ret = lambda.operator() ();
```

æ‰€ä»¥ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´å®šä¹‰äº† `operator()` æˆå‘˜å‡½æ•°çš„ç±»ï¼Œæ˜¯â€œå‡½æ•°å¯¹è±¡â€æˆ–è€…è¯´â€œä»¿å‡½æ•°â€ï¼Œå› ä¸ºå½“ä½ ä½¿ç”¨å‡½æ•°çš„è¯­æ³• `lambda(2)` è°ƒç”¨ä»–ä»¬æ—¶ï¼Œä¼šè§¦å‘ä»–ä»¬çš„æˆå‘˜å‡½æ•° `operator()(2)` ä»è€Œç”¨æ³•å’Œæ™®é€šå‡½æ•°ä¸€æ ·ï¼Œä½†å…¶å®é™…åˆæ˜¯å¯¹è±¡ï¼Œä¹Ÿå°±å¾—åâ€œå‡½æ•°å¯¹è±¡â€å’Œâ€œä»¿å‡½æ•°â€äº†ã€‚

æˆ‘å»ºè®®ä½ è‡ªå·±å» https://cppinsights.io è¿™ä¸ªè§£æ„è¯­æ³•ç³–çš„å·¥å…·ç½‘ç«™åŠ¨åŠ¨æ‰‹è¯•è¯•çœ‹ï¼š

```cpp
auto lambda = [] (int a) {
    return a + 1;
};
int ret = lambda();
```

å®é™…è¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆï¼š

```cpp
struct Lambda {
    int operator() (int a) const {
        return a + 1;
    }
};
Lambda lambda;
int ret = lambda.operator() ();
```

è€Œæ•è·äº†å˜é‡çš„ï¼š

```cpp
int x = 4;
auto lambda = [&x] (int a) {
    return a + x;
};
int ret = lambda();
```

å®é™…è¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆï¼š

```cpp
struct Lambda {
    int &x;

    Lambda(int &x_) : x(x_) {}

    int operator() (int a) const {
        return a + 1;
    }
};
int x = 4;
Lambda lambda(x);
int ret = lambda.operator() ();
```

#### é—­åŒ…æ•è·å˜é‡çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜

æ­£å› å¦‚æ­¤ï¼Œé—­åŒ…æŒ‰å€¼æ•è·ï¼ˆ`[=]`ï¼‰çš„å˜é‡ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå’Œ Lambda å¯¹è±¡ç›¸åŒã€‚

å½“ Lambda å¯¹è±¡è¢«æ‹·è´æ—¶ï¼Œå…¶æŒ‰å€¼æ•è·çš„æ‰€æœ‰å˜é‡ä¹Ÿä¼šè¢«é‡æ–°æ‹·è´ä¸€ä»½ã€‚

å½“ Lambda å¯¹è±¡è¢«ç§»åŠ¨æ—¶ï¼Œå…¶æŒ‰å€¼æ•è·çš„æ‰€æœ‰å˜é‡ä¹Ÿä¼šéšä¹‹ä¸€èµ·ç§»åŠ¨ã€‚

```cpp
struct C {
    C() { fmt::println("C é»˜è®¤æ„é€ "); }
    C(C const &) { fmt::println("C æ‹·è´æ„é€ "); }
    C(C &&) { fmt::println("C ç§»åŠ¨æ„é€ "); }
    C &operator=(C const &) { fmt::println("C æ‹·è´èµ‹å€¼"); }
    C &operator=(C &&) { fmt::println("C ç§»åŠ¨èµ‹å€¼"); }
    ~C() { fmt::println("C ææ„"); }
};

C c;
fmt::println("æ„é€  lambda");
auto lambda = [c] {};
fmt::println("æ‹·è´ lambda åˆ° lambda2");
auto lambda2 = lambda;
fmt::println("ç§»åŠ¨ lambda åˆ° lambda3");
auto lambda3 = lambda;
```

è¾“å‡ºï¼š

```
C é»˜è®¤æ„é€ 
æ„é€  lambda
C æ‹·è´æ„é€ 
æ‹·è´ lambda åˆ° lambda2
C æ‹·è´æ„é€ 
ç§»åŠ¨ lambda åˆ° lambda3
C ç§»åŠ¨æ„é€ 
C ææ„
C ææ„
C ææ„
C ææ„
```

å¦‚æœæŒ‰å€¼æ•è·äº†ä¸èƒ½æ‹·è´çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ `std::unique_ptr`ï¼‰ï¼Œé‚£ä¹ˆ Lambda å¯¹è±¡ä¹Ÿä¼šæ— æ³•æ‹·è´ï¼Œåªèƒ½ç§»åŠ¨ã€‚

```cpp
std::unique_ptr<int> p = std::make_unique<int>(10);
auto lambda = [p] {};                // ç¼–è¯‘é”™è¯¯ğŸ’£å› ä¸ºè¿™é‡Œç­‰ä»·äº [p' = p]ï¼Œæ˜¯å¯¹ p' çš„æ‹·è´æ„é€ 
auto lambda = [p = std::move(p)] {}; // ç¼–è¯‘é€šè¿‡âœ…unique_ptr æ”¯æŒç§»åŠ¨æ„é€ 
auto lambda2 = lambda;               // ç¼–è¯‘é”™è¯¯ğŸ’£std::unique_ptr åªæ”¯æŒç§»åŠ¨ï¼Œä¸æ”¯æŒæ‹·è´
auto lambda2 = std::move(lambda);    // ç¼–è¯‘é€šè¿‡âœ…
```

ç”¨æˆ‘ä»¬ä¹‹å‰çš„æ–¹æ³•è§£æ„è¯­æ³•ç³–åï¼š

```cpp
struct Lambda {
    std::unique_ptr<int> p;
    Lambda(std::unique_ptr<int> ptr) : p(std::move(ptr)) {}

    // Lambda(Lambda const &) = delete;  // å› ä¸ºæœ‰ unique_ptr æˆå‘˜ï¼Œå¯¼è‡´ Lambda çš„æ‹·è´æ„é€ å‡½æ•°è¢«éšå¼åˆ é™¤

    void operator()() const {
    }
};

int main() {
    std::unique_ptr<int> p = std::make_unique<int>(10);
    Lambda lambda(p);            // ç¼–è¯‘é”™è¯¯ğŸ’£
    Lambda lambda(std::move(p)); // ç¼–è¯‘é€šè¿‡âœ…
    return 0;
}
```

#### `mutable` çš„å‡½æ•°å¯¹è±¡

```cpp
int x = 10;
auto lambda = [x] () {
    return x++; // ç¼–è¯‘é”™è¯¯ğŸ’£lambda æ•è·çš„ x é»˜è®¤æ˜¯åªè¯»çš„
};
int ret = lambda();
```

ä¼šè¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆï¼š

```cpp
struct Lambda {
    int x;

    int operator() () const {
        return x++; // ç¼–è¯‘é”™è¯¯ğŸ’£const æˆå‘˜å‡½æ•°ä¸èƒ½ä¿®æ”¹æˆå‘˜å˜é‡
    }
};
int x = 10;
Lambda lambda{x};
int ret = lambda.operator() ();
```

æ³¨æ„åˆ°ï¼Œè¿™é‡Œçš„ `operator()` æˆå‘˜å‡½æ•°æœ‰ä¸€ä¸ª `const` ä¿®é¥°ï¼Œæ„å‘³ç€è¯¥æˆå‘˜å‡½æ•°ä¸èƒ½ä¿®æ”¹å…¶ä½“å†…çš„å˜é‡ã€‚

æ‰€æœ‰ lambda å‡½æ•°å¯¹è±¡ç”Ÿæˆæ—¶é»˜è®¤ï¼Œå°±ä¼šç»™ä»–çš„ `operator()` æˆå‘˜å‡½æ•°åŠ ä¸Š `const` ä¿®é¥°ã€‚

ä¹Ÿå°±æ˜¯è¯´é—­åŒ…æ•è·çš„å˜é‡é»˜è®¤æ˜¯åªè¯»çš„ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹æ•è·çš„å˜é‡ï¼Œå¯ä»¥ç»™ lambda åŠ ä¸Š `mutable` ä¿®é¥°ï¼Œå°±åŠ åœ¨ `()` åé¢ã€‚

```cpp
int x = 10;
auto lambda = [x] () mutable {
    return x++; // ç¼–è¯‘é€šè¿‡âœ…
};
fmt::println("lambda() = {}", lambda()); // 10
fmt::println("lambda() = {}", lambda()); // 11
fmt::println("lambda() = {}", lambda()); // 12
```

ç¼–è¯‘å™¨ç¿»è¯‘äº§ç”Ÿçš„ `Lambda` ç±»çš„æˆå‘˜å‡½æ•°ï¼Œå°±ä¸ä¼šå¸¦ `const` ä¿®é¥°äº†ï¼Œä»è€Œå…è®¸æˆ‘ä»¬çš„å‡½æ•°ä½“ä¿®æ”¹æ•è·çš„éå¼•ç”¨å˜é‡ã€‚

```cpp
struct Lambda {
    int x;

    int operator() () {
        return x++; // ç¼–è¯‘é€šè¿‡âœ…
    }
};
int x = 10;
Lambda lambda{x};
fmt::println("lambda() = {}", lambda.operator() ()); // 10
fmt::println("lambda() = {}", lambda.operator() ()); // 11
fmt::println("lambda() = {}", lambda.operator() ()); // 12
```

æ³¨æ„ï¼šç”±äºä½¿ç”¨äº†å€¼æ•è·ï¼Œlambda ä¿®æ”¹çš„æ˜¯åœ¨ä»–åˆ›å»ºæ—¶å¯¹ `x` çš„ä¸€ä»½æ‹·è´ï¼Œå¤–é¢çš„ `x` ä¸ä¼šæ”¹å˜ï¼

```cpp
int x = 10;
Lambda lambda{x};
fmt::println("lambda() = {}", lambda.operator() ()); // 10
fmt::println("lambda() = {}", lambda.operator() ()); // 11
fmt::println("lambda() = {}", lambda.operator() ()); // 12
fmt::println("x = {}", x);                           // 10
fmt::println("lambda.x = {}", lambda.x);             // 13
```

```cpp
int x = 10;
auto lambda = [x] () mutable {
    return x++; // ç¼–è¯‘é€šè¿‡âœ…
};
fmt::println("ret = {}", lambda()); // 10
fmt::println("ret = {}", lambda()); // 11
fmt::println("ret = {}", lambda()); // 12
fmt::println("x = {}", x);          // 10
fmt::println("lambda.x = {}", lambda.x); // ç¼–è¯‘é”™è¯¯ğŸ’£ç¼–è¯‘å™¨äº§ç”Ÿçš„åŒ¿å lambda å¯¹è±¡ä¸­æ•è·äº§ç”Ÿçš„ x æˆå‘˜å˜é‡æ˜¯åŒ¿åçš„ï¼Œæ— æ³•è®¿é—®
```

#### `auto` æ¨å¯¼è¿”å›å€¼

#### `auto` æ¨å¯¼å‚æ•°

#### ä¸ `decltype` çš„é…åˆ

#### æ— çŠ¶æ€ lambda éšå¼è½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆ

## bind ä¸ºå‡½æ•°å¯¹è±¡ç»‘å®šå‚æ•°

åŸå§‹å‡½æ•°ï¼š

```cpp
int hello(int x, int y) {
    fmt::println("hello({}, {})", x, y);
    return x + y;
}

int main() {
    hello(2, 3);
    hello(2, 4);
    hello(2, 5);
    return 0;
}
```

ç»‘å®šéƒ¨åˆ†å‚æ•°ï¼š

```cpp
int hello(int x, int y) {
    fmt::println("hello({}, {})", x, y);
    return x + y;
}

int main() {
    auto hello2 = std::bind(hello, 2, std::placeholders::_1);
    hello2(3);  // hello(2, 3)
    hello2(4);  // hello(2, 4)
    hello2(5);  // hello(2, 5)
    return 0;
}
```

> {{ icon.tip }} `std::placeholders::_1` è¡¨ç¤º `hello2` çš„ç¬¬ä¸€å‚æ•°ã€‚

> {{ icon.tip }} std::placeholders::_1 åœ¨ bind è¡¨è¾¾å¼ä¸­ä½äº hello çš„çš„ç¬¬äºŒå‚æ•°ä½ç½®ï¼Œè¿™æ„å‘³ç€ï¼šæŠŠ hello2 çš„ç¬¬ä¸€å‚æ•°ï¼Œä¼ é€’åˆ° hello çš„ç¬¬äºŒå‚æ•°ä¸Šå»ã€‚

ç»‘å®šå…¨éƒ¨å‚æ•°ï¼š

```cpp
int hello(int x, int y) {
    fmt::println("hello({}, {})", x, y);
    return x + y;
}

int main() {
    auto hello23 = std::bind(hello, 2, 3);
    hello23();  // hello(2, 3)
    return 0;
}
```

ç»‘å®šå¼•ç”¨å‚æ•°ï¼š

```cpp
int inc(int &x) {
    x += 1;
}

int main() {
    int x = 0;
    auto incx = std::bind(inc, std::ref(x));
    incx();
    fmt::println("x = {}", x); // x = 1
    incx();
    fmt::println("x = {}", x); // x = 2
    return 0;
}
```

> {{ icon.warn }} å¦‚æœä¸ä½¿ç”¨ `std::ref`ï¼Œé‚£ä¹ˆ `main` é‡Œçš„å±€éƒ¨å˜é‡ `x` ä¸ä¼šæ”¹å˜ï¼å› ä¸º `std::bind` æœ‰ä¸€ä¸ªæ¼äººçš„è®¾è®¡ï¼šé»˜è®¤æŒ‰æ‹·è´æ•è·ï¼Œä¼šæŠŠå‚æ•°æ‹·è´ä¸€ä»½ï¼Œè€Œä¸æ˜¯ä¿ç•™å¼•ç”¨ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œplaceholder æŒ‡å®šçš„å‚æ•°ï¼Œå´ä¸éœ€è¦ `std::ref` æ‰èƒ½ä¿æŒå¼•ç”¨ï¼š

```cpp
int inc(int &x, int y) {
    x += y;
}

int main() {
    int x = 0;
    auto inc1 = std::bind(inc, std::placeholders::_1, 1);
    inc1(x);  // æ­¤å¤„ x æ˜¯æŒ‰å¼•ç”¨ä¼ é€’çš„
    fmt::println("x = {}", x); // x = 1
    inc1(x);
    fmt::println("x = {}", x); // x = 2
    return 0;
}
```

é‚£æ˜¯å› ä¸ºï¼Œ`std::placeholders::_1` æŒ‡å®šçš„å‚æ•°ä¼šè¢«ç›´æ¥å®Œç¾è½¬å‘ç»™ `inc` é‡Œçš„ `x`ï¼Œç›¸å½“äº `inc(x, 2);`ã€‚åªæœ‰æ•è·çš„å‚æ•°ä¼šå‘ç”Ÿæ‹·è´ï¼Œä¸ä¼šå®Œç¾è½¬å‘ã€‚

### bind æ˜¯ä¸€ä¸ªå¤±è´¥çš„è®¾è®¡

å½“æˆ‘ä»¬ç»‘å®šå‡ºæ¥çš„å‡½æ•°å¯¹è±¡è¿˜éœ€è¦æ¥å—å‚æ•°æ—¶ï¼Œå°±å˜å¾—å°¤ä¸ºå¤æ‚ï¼šéœ€è¦ä½¿ç”¨å ä½ç¬¦ï¼ˆplaceholderï¼‰ã€‚

```cpp
int func(int x, int y, int z, int &w);

int w = rand();

auto bound = std::bind(func, std::placeholders::_2, 1, std::placeholders::_1, std::ref(w)); //

int res = bound(5, 6); // ç­‰ä»·äº func(6, 1, 5, w);
```

è¿™æ˜¯ä¸€ä¸ªç»‘å®šå™¨ï¼ŒæŠŠ `func` çš„ç¬¬äºŒä¸ªå‚æ•°å’Œç¬¬å››ä¸ªå‚æ•°å›ºå®šä¸‹æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„å‡½æ•°å¯¹è±¡ï¼Œç„¶ååªéœ€è¦ä¼ å…¥å‰é¢ä¸¤ä¸ªå‚æ•°å°±å¯ä»¥è°ƒç”¨åŸæ¥çš„å‡½æ•°äº†ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸æ—§çš„æŠ€æœ¯ï¼ŒC++98 æ—¶ä»£å°±æœ‰äº†ã€‚ä½†æ˜¯ï¼Œç°åœ¨æœ‰äº† Lambda è¡¨è¾¾å¼ï¼Œå¯ä»¥æ›´ç®€æ´åœ°å®ç°ï¼š

```cpp
int func(int x, int y, int z, int &w);

int w = rand();

auto lambda = [&w](int x, int y) { return func(y, 1, x, w); };

int res = lambda(5, 6);
```

Lambda è¡¨è¾¾å¼æœ‰è®¸å¤šä¼˜åŠ¿ï¼š

- ç®€æ´ï¼šä¸éœ€è¦å†™ä¸€å¤§å †çœ‹ä¸æ‡‚çš„ `std::placeholders::_1`ï¼Œç›´æ¥å†™å˜é‡åå°±å¯ä»¥äº†ã€‚
- çµæ´»ï¼šå¯ä»¥åœ¨ Lambda ä¸­ä½¿ç”¨ä»»æ„å¤šçš„å˜é‡ï¼Œè°ƒæ•´é¡ºåºï¼Œè€Œä¸ä»…ä»…æ˜¯ `std::placeholders::_1`ã€‚
- æ˜“æ‡‚ï¼šå†™èµ·æ¥å’Œæ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ ·ï¼Œæ‰€æœ‰äººéƒ½å®¹æ˜“çœ‹æ‡‚ã€‚
- æ•è·å¼•ç”¨ï¼š`std::bind` ä¸æ”¯æŒæ•è·å¼•ç”¨ï¼Œæ€»æ˜¯æ‹·è´å‚æ•°ï¼Œå¿…é¡»é…åˆ `std::ref` æ‰èƒ½æ•è·åˆ°å¼•ç”¨ã€‚è€Œ Lambda å¯ä»¥éšæ„æ•è·ä¸åŒç±»å‹çš„å˜é‡ï¼ŒæŒ‰å€¼ï¼ˆ`[x]`ï¼‰æˆ–æŒ‰å¼•ç”¨ï¼ˆ`[&x]`ï¼‰ï¼Œè¿˜å¯ä»¥ç§»åŠ¨æ•è·ï¼ˆ`[x = move(x)]`ï¼‰ï¼Œç”šè‡³æ•è· thisï¼ˆ`[this]`ï¼‰ã€‚
- å¤¹å¸¦ç§è´§ï¼šå¯ä»¥åœ¨ lambda ä½“å†…å¾ˆæ–¹ä¾¿åœ°å¤¹å¸¦å…¶ä»–é¢å¤–è½¬æ¢æ“ä½œï¼Œæ¯”å¦‚ï¼š

```cpp
auto lambda = [&w](int x, int y) { return func(y + 8, 1, x * x, ++w) * 2; };
```

#### bind çš„å†å²

ä¸ºä»€ä¹ˆ C++11 æœ‰äº† Lambda è¡¨è¾¾å¼ï¼Œè¿˜è¦æå‡º `std::bind` å‘¢ï¼Ÿ

è™½ç„¶ bind å’Œ lambda çœ‹ä¼¼éƒ½æ˜¯åœ¨ C++11 å¼•å…¥çš„ï¼Œå®é™…ä¸Š bind çš„æå‡ºè¿œè¿œæ—©äº lambdaã€‚

> {{ icon.fun }} æ ‡å‡†å§”å‘˜ä¼šï¼šæˆ‘ä»¬ä¸ç”Ÿäº§åº“ï¼Œæˆ‘ä»¬åªæ˜¯ boost çš„æ¬è¿å·¥ã€‚

å½“æ—¶è¿˜æ˜¯ C++98ï¼Œç”±äºæ²¡æœ‰ lambdaï¼Œéš¾ä»¥åˆ›å»ºå‡½æ•°å¯¹è±¡ï¼Œâ€œæ•è·å‚æ•°â€éå¸¸å›°éš¾ã€‚

ä¸ºäº†è§£å†³â€œæ•è·éš¾â€é—®é¢˜ï¼Œåœ¨ç¬¬ä¸‰æ–¹åº“ boost ä¸­æå‡ºäº† `boost::bind`ï¼Œç”±äºå½“æ—¶åªæœ‰ C++98ï¼Œå¾ˆå¤šæœ‰ç›Šäºå‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹æ€§éƒ½æ²¡æœ‰ï¼Œæ‰€ä»¥å®ç°çš„éå¸¸ä¸‘é™‹ã€‚

ä¾‹å¦‚ï¼Œå› ä¸º C++98 æ²¡æœ‰å˜é•¿æ¨¡æ¿å‚æ•°ï¼Œæ— æ³•å®ç° `<class ...Args>`ã€‚æ‰€ä»¥å®é™…ä¸Šå½“æ—¶ boost æ‰€æœ‰æ”¯æŒå¤šå‚æ•°çš„å‡½æ•°ï¼Œå®é™…ä¸Šéƒ½æ˜¯é€šè¿‡ï¼š

```cpp
void some_func();
void some_func(int i1);
void some_func(int i1, int i2);
void some_func(int i1, int i2, int i3);
void some_func(int i1, int i2, int i3, int i4);
// ...
```

è¿™æ ·æš´åŠ›é‡è½½å‡ åä¸ªå‡½æ•°æ¥å®ç°çš„ï¼Œè€Œä¸”å‚æ•°æ•°é‡æœ‰ä¸Šé™ã€‚é€šå¸¸ä¼šå®ç° 0 åˆ° 20 ä¸ªå‚æ•°çš„é‡è½½ï¼Œæ›´å¤šå°±ä¸æ”¯æŒäº†ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬çŸ¥é“ç°åœ¨ bind éœ€è¦é…åˆå„ç§ `std::placeholders::_1` ä½¿ç”¨ï¼Œæœ‰æ²¡æœ‰æƒ³è¿‡è¿™å¥—ä¸‘é™‹çš„å ä½ç¬¦æ˜¯ä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨ `std::placeholder<1>`ï¼Œè¿™æ ·ä¸æ˜¯æ›´å¯æ‰©å±•å—ï¼Ÿ

æ²¡é”™ï¼Œå½“æ—¶ `boost::bind` å°±æ˜¯ç”¨æš´åŠ›é‡è½½å‡ åä¸ªå‚æ•°æ•°é‡ä¸ç­‰çš„å‡½æ•°ï¼Œæ’åˆ—ç»„åˆï¼Œå—¯æ˜¯æ’å‡ºæ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šçœ‹åˆ° `boost::placeholders` åªæœ‰æœ‰é™ä¸ªæ•°çš„å ä½ç¬¦æ•°é‡ã€‚

ç³Ÿç³•çš„æ˜¯ï¼Œæ ‡å‡†åº“çš„ `std::bind` æŠŠ `boost::bind` åŸå°ä¸åŠ¨æ¬äº†è¿‡æ¥ï¼Œç”šè‡³ `placeholders` çš„æš´åŠ›ç»„åˆä¹Ÿæ²¡æœ‰å˜ï¼Œé€ æˆäº† `std::bind` å¦‚ä»Šä¸‘é™‹çš„æ¥å£ã€‚

äººå®¶ `boost::bind` æ˜¯å› ä¸ºä¸èƒ½ä¿®æ”¹è¯­è¨€è¯­æ³•ï¼Œæ‰åªèƒ½é‚£æ ·æ†‹å±ˆçš„å•Šï¼Ÿå¯ç°åœ¨ä½ ç æ˜¯æ ‡å‡†å§”å‘˜ä¼šå•Šï¼Œä½ å¯ä»¥ä¿®æ”¹è¯­è¨€è¯­æ³•å•Šï¼Ÿ

ç„¶è€Œï¼ŒC++ æ ‡å‡†çš„æ›´æ–°æ˜¯ä»¥â€œææ¡ˆâ€çš„æ–¹å¼ï¼Œé€æ­¥â€œå¢é‡â€æ›´æ–°è¿›å…¥è¯­è¨€æ ‡å‡†çš„ã€‚å³ä½¿æ˜¯åœ¨ C++98 åˆ° C++11 è¿™æ®µæ—¶é—´å†…ï¼Œå†…éƒ¨ä¹Ÿæ˜¯æœ‰ä¸€ä¸ªå¾ˆé•¿çš„æ¶ˆåŒ–æµç¨‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å¾ˆå¤šå­ç‰ˆæœ¬ï¼Œåªæ˜¯å¯¹å¤–çœ‹èµ·æ¥å¥½åƒåªæœ‰ä¸€ä¸ª C++11ã€‚

æ¯”æ–¹è¯´ï¼Œæˆ‘ 2001 å¹´æå‡º `std::bind` ææ¡ˆï¼Œ2005 å¹´è¢«æ‰¹å‡†è¿›å…¥æœªæ¥å°†è¦å‘å¸ƒçš„ C++11 æ ‡å‡†ã€‚ç„¶ååˆä¸€ä¸ªäººåœ¨ 2006 å¹´æå‡ºå…¶å®ä¸éœ€è¦ bindï¼Œå®Œå…¨å¯ä»¥ç”¨æ›´å¥½çš„ lambda è¯­æ³•æ¥ä»£æ›¿ bindï¼Œç„¶åç­‰åˆ°äº† 2008 å¹´æ‰æ‰¹å‡†è¿›å…¥å³å°†å‘å¸ƒçš„ C++11 æ ‡å‡†ã€‚ä½†æ˜¯å·²ç»è¿›å…¥æ ‡å‡†çš„ä¸œè¥¿å°±ä¸ä¼šå†é€€å‡ºäº†ï¼Œå“ªæ€•è¿˜æ²¡æœ‰å‘å¸ƒã€‚å°±è¿™æ · bind å’Œ lambda åŒæ—¶è¿›å…¥äº†æ ‡å‡†ã€‚

æ‰€ä»¥é—¹äº†åŠå¤©ï¼Œlambda å®é™…ä¸Šæ˜¯ bind çš„ä¸Šä½æ›¿ä»£ï¼Œæœ‰äº† lambda æ ¹æœ¬ä¸éœ€è¦ bind çš„ã€‚åªä¸è¿‡æ˜¯ç”±äº C++ å§”å‘˜ä¼šå‰åæ‰¯çš®çš„â€œåˆ¶åº¦ä¼˜åŠ¿â€ï¼Œå¯¼è‡´ bind å’Œä»–çš„ä¸Šä½æ›¿ä»£ lambda åŒæ—¶è¿›å…¥äº† C++11 æ ‡å‡†ä¸€èµ·å‘å¸ƒã€‚

> {{ icon.fun }} è¿™ä¸‹çœ‹æ‡‚äº†ã€‚

å¾ˆå¤šåŒå­¦å°±ä¸ç†è§£ï¼Œå°å½­è€å¸ˆè¯´â€œlambda æ˜¯ bind çš„ä¸Šä½æ›¿ä»£â€ï¼Œä»–å°±è´¨ç–‘â€œå¯ä»–ä»¬ä¸éƒ½æ˜¯ C++11 æå‡ºçš„å—ï¼Ÿâ€

æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼ŒC++11 å’Œ C++98 ä¹‹é—´ä¸ºä»€ä¹ˆå¹´ä»£å·®äº†é‚£ä¹ˆä¹…è¿œï¼Œå°±æ˜¯å› ä¸ºä¸€ä¸ªæ ‡å‡†ä¸€æ‹–å†æ‹–ï¼Œå†…éƒ¨å®é™…ä¸Šå·²ç»è¿­ä»£äº†å¥½å‡ ä¸ªå°ç‰ˆæœ¬äº†ï¼Œæ‰å‘å¸ƒå‡ºæ¥ã€‚

> {{ icon.story }} å†ä¸¾ä¸ªä¾‹å­ï¼ŒCTAD å’Œ `optional` éƒ½æ˜¯ C++17 å¼•å…¥çš„ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ `make_optional` è¿™ä¸ªå¸®æ‰‹å‡½æ•°ï¼Ÿä¸æ˜¯è¯´ CTAD æ˜¯ `make_xxx` çš„ä¸Šä½æ›¿ä»£å—ï¼Ÿå¯è§ï¼ŒC++ æ ‡å‡†ä¸­è¿™ç§â€œåŒä¸€ä¸ªç‰ˆæœ¬å†…â€è‡ªå·±æ‰“è‡ªå·±è€³å…‰çš„ç°è±¡æ¯”æ¯”çš†æ˜¯ã€‚

> {{ icon.fun }} æ‰€ä»¥ï¼Œç°åœ¨è¿˜åšæŒç”¨ bind çš„ï¼Œéƒ½æ˜¯äº› 2005 å¹´å‰ååœ¨è±¡ç‰™å¡”æ¥å— C++ æ•™è‚²ï¼Œä½†åˆä¸è‚¯â€œç»ˆèº«å­¦ä¹ â€çš„åŠ³ä¿ã€‚è¿™æ‰¹åŠ³ä¿åˆå»â€œä¸Šå²¸â€å½“â€œæ•™å¸ˆâ€ï¼Œç»§ç»­å¤åˆ¶ 2005 å¹´çš„é”™è¯¯æ¯’å®³é’å°‘å¹´ï¼Œå®ç°äº†åŠ³ä¿çš„å†ç”Ÿäº§ã€‚

#### thread è†ç›–ä¸­ç®­

ç³Ÿç³•çš„æ˜¯ï¼Œbind çš„è¿™ç§è¼æ¯’ï¼Œç”šè‡³å½±å“åˆ°äº†çº¿ç¨‹åº“ï¼š`std::thread` çš„æ„é€ å‡½æ•°å°±æ˜¯åŸºäº `std::bind` çš„ï¼

è¿™å¯¼è‡´äº† `std::thread` å’Œ `std::bind` ä¸€æ ·ï¼Œæ— æ³•æ•è·å¼•ç”¨ã€‚

```cpp
void thread_func(int &x) {
    x = 42;
}

int x = 0;
std::thread t(thread_func, x);
t.join();
printf("%d\n", x); // 0
```

ä¸ºäº†é¿å…è¸©åˆ° bind çš„å‘ï¼Œæˆ‘å»ºè®®æ‰€æœ‰åŒå­¦ï¼Œæ„é€  `std::thread` æ—¶ï¼Œç»Ÿä¸€åªæŒ‡å®šâ€œå•ä¸ªå‚æ•°â€ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°æœ¬èº«ã€‚å¦‚æœéœ€è¦æ•è·å‚æ•°ï¼Œè¯·ä½¿ç”¨ lambdaã€‚å› ä¸º lambda ä¸­ï¼Œæ•è·äº†å“ªäº›å˜é‡ï¼Œå‚æ•°çš„é¡ºåºæ˜¯ä»€ä¹ˆï¼Œå“ªäº›æ•è·æ˜¯å¼•ç”¨ï¼Œå“ªäº›æ•è·æ˜¯æ‹·è´ï¼Œéå¸¸æ¸…æ™°ã€‚

```cpp
void thread_func(int &x) {
    x = 42;
}

int x = 0;
std::thread t([&x] {  // [&x] è¡¨ç¤ºæŒ‰å¼•ç”¨æ•è· xï¼›å¦‚æœå†™ä½œ [x]ï¼Œé‚£å°±æ˜¯æ‹·è´æ•è·
    thread_func(x);
});
t.join();
printf("%d\n", x); // 42
```

#### æ¡ˆä¾‹ï¼šç»‘å®šéšæœºæ•°ç”Ÿæˆå™¨

bind å†™æ³•ï¼š

```cpp
std::mt19937 gen(seed);
std::uniform_real_distribution<double> uni(0, 1);
auto frand = std::bind(uni, std::ref(gen));
double x = frand();
double y = frand();
```

æ”¹ç”¨ lambdaï¼š

```cpp
std::mt19937 gen(seed);
std::uniform_real_distribution<double> uni(0, 1);
auto frand = [uni, &gen] {
    return uni(gen);
};
double x = frand();
double y = frand();
```

### `std::bind_front` å’Œ `std::bind_back`

C++17 å¼•å…¥äº†ä¸¤ä¸ªæ–°ç»‘å®šå‡½æ•°ï¼š

- `std::bind_front`ï¼šç»‘å®šæœ€å‰çš„è‹¥å¹²ä¸ªå‚æ•°ï¼Œåé¢çš„å‚æ•°è‡ªåŠ¨æ·»åŠ å ä½ç¬¦ï¼›
- `std::bind_back`ï¼šç»‘å®šæœ«å°¾çš„è‹¥å¹²ä¸ªå‚æ•°ï¼Œå‰é¢çš„å‚æ•°è‡ªåŠ¨æ·»åŠ å ä½ç¬¦ã€‚

å’Œæ™®é€šçš„ `std::bind` ç›¸æ¯”æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ

å¯¹äºå‡½æ•°å‚æ•°éå¸¸å¤šï¼Œä½†å®é™…åªéœ€è¦ç»‘å®šä¸€ä¸¤ä¸ªå‚æ•°çš„æƒ…å†µï¼Œç”¨ `std::bind` ä¼šéœ€è¦æ·»åŠ éå¸¸å¤šçš„ placeholderï¼Œæ•°é‡å’Œå‡½æ•°çš„å‰©ä½™å‚æ•°æ•°é‡ä¸€æ ·å¤šã€‚è€Œ `std::bind_front` åˆ™ç›¸å½“äºä¸€ä¸ªç®€å†™ï¼Œåé¢çš„å ä½ç¬¦å¯ä»¥çœç•¥ä¸å†™äº†ã€‚

ä¾‹å¦‚ç»‘å®š x = 42ï¼š

```cpp
int func(int x, int y, int z);

auto bound = std::bind(func, 42, std::placeholders::_1, std::placeholders::_2);
// ç­‰ä»·äºï¼š
auto bound = std::bind_front(func, 42);
```

ç»‘å®š z = 42ï¼š

```cpp
int func(int x, int y, int z);

auto bound = std::bind(func, std::placeholders::_1, std::placeholders::_2, 42);
// ç­‰ä»·äºï¼š
auto bound = std::bind_back(func, 42);
```

å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨è¿™ä¸¤ä¸ªæ–°ç»‘å®šå‡½æ•°æ˜æ˜¾å†™çš„ä»£ç å°‘äº†ã€‚

> {{ icon.tip }} å…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯ `std::bind_front`ï¼Œç”¨äºç»‘å®šç±»æˆå‘˜çš„ `this` æŒ‡é’ˆã€‚

### æ¡ˆä¾‹ï¼šç»‘å®šæˆå‘˜å‡½æ•°

ä½¿ç”¨â€œæˆå‘˜å‡½æ•°æŒ‡é’ˆâ€è¯­æ³•ï¼ˆè¿™ä¸€å¥‡è‘©è¯­æ³•åœ¨ C++98 å°±æœ‰ï¼‰é…åˆ `std::bind`ï¼Œå¯ä»¥å®ç°ç»‘å®šä¸€ä¸ªç±»å‹çš„æˆå‘˜å‡½æ•°ï¼š

```cpp
struct Class {
    void world() {
        puts("world!");
    }

    void hello() {
        auto memfn = std::bind(&Class::world, this); // å°† this->world ç»‘å®šæˆä¸€ä¸ªå¯ä»¥å»¶åè°ƒç”¨çš„å‡½æ•°å¯¹è±¡
        memfn();
        memfn();
    }
}
```

ä¸å°±æ˜¯æ•è· this å—ï¼Ÿæˆ‘ä»¬ lambda ä¹Ÿå¯ä»¥è½»æ˜“åšåˆ°ï¼ä¸”æ— éœ€ç¹çåœ°å†™å‡º this ç±»çš„å®Œæ•´ç±»åï¼Œè¿˜å†™ä¸ªè„‘ç˜« `&::` å¼ºç¢±ä½ çš„é”®ç›˜ã€‚

```cpp
struct Class {
    void world() {
        puts("world!");
    }

    void hello() {
        auto memfn = [this] {
            world(); // ç­‰ä»·äº this->world()
        };
        memfn();
        memfn();
    }
}
```

bind çš„ç¼ºç‚¹æ˜¯ï¼Œå½“æˆ‘ä»¬çš„æˆå‘˜å‡½æ•°å«æœ‰å¤šä¸ªå‚æ•°æ—¶ï¼Œbind å°±éå¸¸éº»çƒ¦äº†ï¼šéœ€è¦ä¸€ä¸ªä¸ªå†™å‡º placeholderï¼Œè€Œä¸”æ•°é‡å¿…é¡»å’Œ `world` çš„å‚æ•°æ•°é‡ä¸€è‡´ã€‚æ¯æ¬¡ `world` è¦æ–°å¢å‚æ•°æ—¶ï¼Œæ‰€æœ‰ bind çš„åœ°æ–¹éƒ½éœ€è¦åŠ ä¸€ä¸‹ placeholderï¼Œéå¸¸æ²™é›•ã€‚

```cpp
struct Class {
    void world(int x, int y) {
        printf("world(%d, %d)\n");
    }

    void hello() {
        auto memfn = std::bind(&Class::world, this, std::placeholders::_1, std::placeholders::_2);
        memfn(1, 2);
        memfn(3, 4);
    }
}
```

è€Œä¸”ï¼Œå¦‚æœæœ‰è¦ç»‘å®šçš„ç›®æ ‡å‡½æ•°æœ‰å¤šä¸ªå‚æ•°æ•°é‡ä¸åŒçš„é‡è½½ï¼Œé‚£ bind å°±å®Œå…¨ä¸èƒ½å·¥ä½œäº†ï¼

```cpp
struct Class {
    void world(int x, int y) {
        printf("world(%d, %d)\n");
    }

    void world(double x) {
        printf("world(%d)\n");
    }

    void hello() {
        auto memfn = std::bind(&Class::world, this, std::placeholders::_1, std::placeholders::_2);
        memfn(1, 2);
        memfn(3.14); // ç¼–è¯‘å‡ºé”™ï¼æ­»æ‰£å ä½ç¬¦çš„ bind å¿…é¡»è¦æ±‚ä¸¤ä¸ªå‚æ•°ï¼Œå³ä½¿ world æ˜æ˜æœ‰å•å‚æ•°çš„é‡è½½

        auto memfn_1arg = std::bind(&Class::world, this, std::placeholders::_1);
        memfn_1arg(3.14); // å¿…é¡»é‡æ–°ç»‘å®šä¸€ä¸ªâ€œå•å‚æ•°ç‰ˆâ€æ‰ OK
    }
}
```

## ä½¿ç”¨ `std::bind_front` ä»£æ›¿

ä¸ºäº†è§£å†³ bind ä¸èƒ½æ•è·å¤šå‚æ•°é‡è½½çš„æƒ…å†µï¼ŒC++17 å¼•å…¥äº† `std::bind_front` å’Œ `std::bind_back`ï¼Œä»–ä»¬ä¸éœ€è¦ placeholderï¼Œä½†åªèƒ½ç”¨äºè¦ç»‘å®šçš„å‚æ•°åœ¨æœ€å‰æˆ–è€…æœ€åçš„ç‰¹æ®Šæƒ…å†µã€‚

å…¶ä¸­ `std::bind_front` å¯¹äºæˆ‘ä»¬åªéœ€è¦æŠŠç¬¬ä¸€ä¸ªå‚æ•°ç»‘å®šä¸º `this`ï¼Œå…¶ä»–å‚æ•°å¦‚æ•°è½¬å‘çš„åœºæ™¯ï¼Œç®€ç›´æ˜¯é›ªä¸­é€ç‚­ï¼

```cpp
struct Class {
    void world(int x, int y) {
        printf("world(%d, %d)\n");
    }

    void world(double x) {
        printf("world(%d)\n");
    }

    void hello() {
        auto memfn = std::bind_front(&Class::world, this);
        memfn(1, 2);
        memfn(3.14); // OKï¼
    }
}
```

```cpp
auto memfn = std::bind_front(&Class::world, this); // C++17 çš„ bind å­å­è¡¥æ•‘æªæ–½
auto memfn = BIND(world, this);                    // å°å½­è€å¸ˆçš„ BIND å®ï¼ŒC++14 èµ·å¯ç”¨
```

ä½ æ›´å–œæ¬¢å“ªä¸€ç§å‘¢ï¼Ÿ

#### ä½¿ç”¨ lambda ä»£æ›¿

è€Œ C++14 èµ· lambda æ”¯æŒäº†å˜é•¿å‚æ•°ï¼Œå°±ä¸ç”¨è¿™ä¹ˆæ­»æ¿ï¼š

```cpp
struct Class {
    void world(int x, int y) {
        printf("world(%d, %d)\n");
    }

    void world(double x) {
        printf("world(%d)\n");
    }

    void hello() {
        auto memfn = [this] (auto ...args) { // è®© lambda æ¥å—ä»»æ„å‚æ•°
            world(args...); // æ‹·è´è½¬å‘æ‰€æœ‰å‚æ•°ç»™ world
        };
        memfn(1, 2); // åŒå‚æ•°ï¼šOK
        memfn(3.14); // å•å‚æ•°ï¼šOK
    }
}
```

æ›´å¥½çš„æ˜¯é…åˆ `forward` å®ç°å‚æ•°çš„å®Œç¾è½¬å‘ï¼š

```cpp
struct Class {
    void world(int &x, int &&y) {
        printf("world(%d, %d)\n");
        ++x;
    }

    void world(double const &x) {
        printf("world(%d)\n");
    }

    void hello() {
        auto memfn = [this] (auto &&...args) { // è®© lambda æ¥å—ä¸‡èƒ½å¼•ç”¨åšå‚æ•°
            world(std::forward<decltype(args)>(args)...); // é€šè¿‡ FWD å®Œç¾è½¬å‘ç»™ worldï¼Œé¿å…å¼•ç”¨é€€åŒ–
        };
        int x = 1;
        memfn(x, 2); // åŒå‚æ•°ï¼šOK
        memfn(3.14); // å•å‚æ•°ï¼šOK
    }
}
```

### å‡½æ•°æŒ‡é’ˆæ˜¯ C è¯­è¨€é™‹ä¹ ï¼Œæ”¹æ‰
